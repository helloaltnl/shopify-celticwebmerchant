class CartEvents{constructor(){this.events={}}subscribe(t,e){return this.events[t]||(this.events[t]=[]),this.events[t].push(e),()=>{this.events[t]=this.events[t].filter((t=>t!==e))}}publish(t,e){this.events[t]&&this.events[t].forEach((t=>t(e)))}}window.CartEvents=new CartEvents;class CartUpdater{constructor(){this.isUpdating=!1}getSectionsToUpdate(t="page",e=null){const a=[],n="page"===t?document.querySelector("[data-cart-main-section]")?.dataset.cartMainSection:document.querySelector("[data-cart-preview-section]")?.dataset.cartPreviewSection;if(!n)return a;if("page"===t){const t=document.querySelector("[data-cart-main-section]");if(e&&0===e.item_count&&t)return a.push({id:n,selector:"[data-cart-main-section]",target:t,replaceWhole:!0}),a;const i=document.querySelector("[data-cart-items-section]"),r=document.querySelector("[data-cart-subtotal-section]"),s=document.querySelector("[data-cart-payments-section]");i&&a.push({id:n,selector:"[data-cart-items-section]",target:i}),r&&a.push({id:n,selector:"[data-cart-subtotal-section]",target:r}),s&&a.push({id:n,selector:"[data-cart-payments-section]",target:s})}else if("drawer"===t||"preview"===t){const t=document.querySelector("[data-cart-preview-section]");if(!t)return a;const e=t.querySelector("[data-cart-items-section]"),i=t.querySelector("[data-cart-subtotal-section]"),r=t.querySelector("[data-cart-payments-section]");e&&a.push({id:n,selector:"[data-cart-preview-section] [data-cart-items-section]",target:e}),i&&a.push({id:n,selector:"[data-cart-preview-section] [data-cart-subtotal-section]",target:i}),r&&a.push({id:n,selector:"[data-cart-preview-section] [data-cart-payments-section]",target:r})}return a}async updateSections(t,e){if(!t||0===t.length)return;const a=t.map((t=>t.id)).filter(Boolean);if(0!==a.length)try{const e=new URLSearchParams({sections:a.join(",")}),n=await fetch(`${window.Shopify.routes.root}?${e}`),i=await n.json();return t.forEach((t=>{if(!t.target||!t.selector||!t.id)return;const e=i[t.id];if(!e)return;const a=(new DOMParser).parseFromString(e,"text/html").querySelector(t.selector);a&&(t.replaceWhole?t.target.outerHTML=a.outerHTML:t.target.innerHTML=a.innerHTML)})),!0}catch(t){return console.error("Cart section update failed:",t),!1}}async update(t={}){const{context:e="page",cartData:a=null,skipSections:n=[]}=t;if(!this.isUpdating){this.isUpdating=!0,window.CartEvents.publish("cart:loading",{context:e});try{let t=this.getSectionsToUpdate(e,a);return t=t.filter((t=>!n.includes(t.id))),await this.updateSections(t,a),window.CartEvents.publish("cart:loaded",{context:e,cartData:a}),!0}catch(t){return console.error("Cart update failed:",t),window.CartEvents.publish("cart:error",{error:t,context:e}),!1}finally{this.isUpdating=!1}}}}window.CartUpdater=new CartUpdater;class CartAPI{async add(t){window.CartEvents.publish("cart:loading",{action:"add"});try{const e=await fetch(window.Shopify.routes.root+"cart/add.js",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.description||"Failed to add item to cart")}const a=await e.json(),n=await this.get();return window.CartEvents.publish("cart:add",{item:a,cart:n}),window.CartEvents.publish("cart:update",{cart:n,action:"add"}),n}catch(t){throw console.error("Add to cart failed:",t),window.CartEvents.publish("cart:error",{error:t,action:"add"}),t}}async change(t){window.CartEvents.publish("cart:loading",{action:"change"});try{const e=await fetch(window.Shopify.routes.root+"cart/change.js",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.description||"Failed to update cart")}const a=await e.json();return window.CartEvents.publish("cart:change",{cart:a,line:t.line,quantity:t.quantity}),window.CartEvents.publish("cart:update",{cart:a,action:"change"}),a}catch(t){throw console.error("Cart change failed:",t),window.CartEvents.publish("cart:error",{error:t,action:"change"}),t}}async update(t){window.CartEvents.publish("cart:loading",{action:"update"});try{const e=await fetch(window.Shopify.routes.root+"cart/update.js",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({updates:t})});if(!e.ok){const t=await e.json();throw new Error(t.description||"Failed to update cart")}const a=await e.json();return window.CartEvents.publish("cart:update",{cart:a,action:"update"}),a}catch(t){throw console.error("Cart update failed:",t),window.CartEvents.publish("cart:error",{error:t,action:"update"}),t}}async get(){try{const t=await fetch(window.Shopify.routes.root+"cart.js",{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!t.ok)throw new Error("Failed to fetch cart data");return await t.json()}catch(t){throw console.error("Get cart failed:",t),t}}async updateNote(t){window.CartEvents.publish("cart:loading",{action:"note"});try{const e=await fetch(window.Shopify.routes.root+"cart/update.js",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({note:t})});if(!e.ok)throw new Error("Failed to update cart note");const a=await e.json();return window.CartEvents.publish("cart:note",{cart:a,note:t}),window.CartEvents.publish("cart:update",{cart:a,action:"note"}),a}catch(t){throw console.error("Update cart note failed:",t),window.CartEvents.publish("cart:error",{error:t,action:"note"}),t}}async clear(){window.CartEvents.publish("cart:loading",{action:"clear"});try{if(!(await fetch(window.Shopify.routes.root+"cart/clear.js",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"}})).ok)throw new Error("Failed to clear cart");const t=await this.get();return window.CartEvents.publish("cart:update",{cart:t,action:"clear"}),t}catch(t){throw console.error("Clear cart failed:",t),window.CartEvents.publish("cart:error",{error:t,action:"clear"}),t}}}window.CartAPI=new CartAPI;class CartRemoveButton extends HTMLElement{constructor(){super(),this.addEventListener("click",this.handleClick.bind(this))}async handleClick(t){t.preventDefault();const e=parseInt(this.dataset.line),a=this.closest("[data-cart-context]")?.dataset.cartContext||"page";this.enableLoading();try{const t=await window.CartAPI.change({line:e,quantity:0});await window.CartUpdater.update({context:a,cartData:t}),window.CartEvents.publish("cart:remove",{line:e,cart:t})}catch(t){this.showError(t.message)}finally{this.disableLoading()}}enableLoading(){this.classList.add("loading"),this.disabled=!0}disableLoading(){this.classList.remove("loading"),this.disabled=!1}showError(t){console.error("Remove failed:",t)}}customElements.define("cart-remove-button",CartRemoveButton);class CartQuantityInput extends HTMLElement{constructor(){super(),this.input=this.querySelector('input[type="number"]'),this.minusBtn=this.querySelector('[name="minus"]'),this.plusBtn=this.querySelector('[name="plus"]'),this.debounceTimer=null,this.input&&this.input.addEventListener("change",this.handleChange.bind(this)),this.minusBtn&&this.minusBtn.addEventListener("click",this.handleMinus.bind(this)),this.plusBtn&&this.plusBtn.addEventListener("click",this.handlePlus.bind(this))}async handleChange(t){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout((async()=>{let t=parseInt(this.input.value);const e=parseInt(this.input.dataset.line),a=this.closest("[data-cart-context]")?.dataset.cartContext||"page",n=parseInt(this.input.dataset.min||1),i=this.input.max?parseInt(this.input.max):null;parseInt(this.input.step||1);(isNaN(t)||t<n)&&(t=n,this.input.value=n),i&&t>i&&(t=i,this.input.value=i,this.showError(`Maximum quantity is ${i}`)),this.enableLoading();try{const n=await window.CartAPI.change({line:e,quantity:t});await window.CartUpdater.update({context:a,cartData:n})}catch(t){this.showError(t.message),this.input.value=this.input.dataset.previousValue||n}finally{this.disableLoading()}}),500)}handleMinus(t){t.preventDefault();const e=parseInt(this.input.value),a=parseInt(this.input.dataset.min||0),n=parseInt(this.input.step||1);e-n>=a&&(this.input.value=e-n,this.input.dispatchEvent(new Event("change")))}handlePlus(t){t.preventDefault();const e=parseInt(this.input.value),a=this.input.max?parseInt(this.input.max):null,n=parseInt(this.input.step||1);(!a||e+n<=a)&&(this.input.value=e+n,this.input.dispatchEvent(new Event("change")))}enableLoading(){this.classList.add("loading"),this.input.disabled=!0,this.minusBtn&&(this.minusBtn.disabled=!0),this.plusBtn&&(this.plusBtn.disabled=!0)}disableLoading(){this.classList.remove("loading"),this.input.disabled=!1,this.minusBtn&&(this.minusBtn.disabled=!1),this.plusBtn&&(this.plusBtn.disabled=!1)}showError(t){const e=this.closest("[data-cart-item]")?.querySelector("[data-cart-item-error]");e&&(e.textContent=t,e.style.display="block",setTimeout((()=>{e.style.display="none"}),3e3))}}customElements.define("cart-quantity-input",CartQuantityInput);class CartNote extends HTMLElement{constructor(){super(),this.textarea=this.querySelector("textarea"),this.debounceTimer=null,this.textarea&&this.textarea.addEventListener("input",this.handleInput.bind(this))}handleInput(t){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout((async()=>{const t=this.textarea.value;try{await window.CartAPI.updateNote(t)}catch(t){console.error("Update note failed:",t)}}),1e3)}}customElements.define("cart-note",CartNote);class CartAddButton extends HTMLElement{constructor(){super(),this.button=this.querySelector("button"),this.button&&this.button.addEventListener("click",this.handleClick.bind(this))}async handleClick(t){t.preventDefault();const e=this.dataset.variantId,a=parseInt(this.dataset.quantity||1);if(e&&!this.classList.contains("loading")){this.enableLoading();try{await window.CartAPI.add({id:parseInt(e),quantity:a})}catch(t){console.error("Add to cart failed:",t)}finally{this.disableLoading()}}}enableLoading(){this.classList.add("loading"),this.button&&(this.button.disabled=!0)}disableLoading(){this.classList.remove("loading"),this.button&&(this.button.disabled=!1)}}function initializeCart(){console.log("Cart system initialized"),window.CartEvents.subscribe("cart:update",(async t=>{console.log("Cart updated:",t);const e=document.querySelector("[data-cart-main-section]"),a=document.querySelector("[data-cart-preview-section]");var n;e&&await window.CartUpdater.update({context:"page",cartData:t.cart}),a&&await window.CartUpdater.update({context:"preview",cartData:t.cart}),n=t.cart.item_count,document.querySelectorAll("[data-cart-count]").forEach((t=>{t.textContent=n,t.style.display=n>0?"":"none"}))})),window.CartEvents.subscribe("cart:add",(t=>{!("/cart"===window.location.pathname||window.location.pathname.includes("/cart"))&&window.CartPreview&&"function"==typeof window.CartPreview.open&&setTimeout((()=>{window.CartPreview.open()}),300)}))}customElements.define("cart-add-button",CartAddButton),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeCart):initializeCart();