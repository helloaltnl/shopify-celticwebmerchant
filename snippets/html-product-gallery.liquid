{%- comment -%}
Snippet: html-product-gallery
Params:
	product / product_handle
	img_width_main (default 800)
	img_width_thumb (default 240)
	loading ('lazy'|'eager', default 'lazy')
{%- endcomment -%}

{%- assign p = product -%}
{%- if p == blank and product_handle != blank -%}
	{%- assign p = all_products[product_handle] -%}
{%- endif -%}

{%- assign img_w_main  = img_width_main  | default: 800 -%}
{%- assign img_w_thumb = img_width_thumb | default: 240 -%}
{%- assign loading     = loading         | default: 'lazy' -%}

<div class="product-gallery" data-product-gallery>
	{%- comment -%} Main Slider {%- endcomment -%}
	<div class="product-gallery__main"
		data-swiper
		data-swiper-id="{{ product.id }}"
		data-swiper-options='{ "slidesPerView": "auto", "spaceBetween": 8, "speed": 300 }'
	>
		<ul class="product-gallery__slides" data-swiper-wrapper>
			{%- for media in p.media -%}
				<li class="product-gallery__slide" data-media-id="{{ media.id }}">
					{%- render 'html-product-media',
						media: media,
						product: p,
						mode: 'main',
						img_w: img_w_main,
						loading: loading
					-%}
				</li>
			{%- endfor -%}
		</ul>

		{%- if p.media.size > 1 -%}
			<button class="product-gallery__nav product-gallery__nav--prev" data-swiper-prev aria-label="{{ 'accessibility.slider.previous' | t }}">
				{% render 'html-theme-icons', icon: 'chevron-left', size: 24 %}
			</button>
			<button class="product-gallery__nav product-gallery__nav--next" data-swiper-next aria-label="{{ 'accessibility.slider.next' | t }}">
				{% render 'html-theme-icons', icon: 'chevron-right', size: 24 %}
			</button>
		{%- endif -%}

		{%- comment -%} Share button (triggers global share modal) {%- endcomment -%}
		<button 
			class="product-gallery__share-btn" 
			type="button" 
			data-modal-trigger="share-modal"
			data-share-url="{{ p.url | prepend: shop.url }}"
			data-share-title="{{ p.title | escape }}"
			data-share-image="{{ p.featured_image | image_url: width: 1200 }}"
			aria-label="{{ 'general.share' | t | default: 'Share' }}"
		>
			{% render 'html-theme-icons', icon: 'share', size: 20 %}
		</button>

		{%- comment -%} Fullscreen button {%- endcomment -%}
		<button 
			class="product-gallery__fullscreen-btn" 
			type="button" 
			data-gallery-fullscreen-open
			aria-label="{{ 'product.media.gallery' | t | default: 'Open fullscreen gallery' }}"
		>
			{% render 'html-theme-icons', icon: 'zoom', size: 20 %}
		</button>
	</div>

	{%- comment -%} Thumbs {%- endcomment -%}
	{%- if p.media.size > 1 -%}
		<div class="product-gallery__thumbs"
			data-swiper
			data-swiper-slave="{{ product.id }}"
			data-swiper-options='{ "slidesPerView": "auto", "spaceBetween": 4, "freeMode": true, "watchSlidesProgress": true }'
		>
			<ul class="product-gallery__slides" data-swiper-wrapper>
				{%- for media in p.media -%}
					<li class="product-gallery__slide product-gallery__slide--thumb" data-media-id="{{ media.id }}">
						{%- render 'html-product-media',
							media: media,
							product: p,
							mode: 'thumb',
							img_w: img_w_thumb,
							loading: 'lazy'
						-%}
					</li>
				{%- endfor -%}
			</ul>
		</div>
	{%- endif -%}

	{%- comment -%} Close button (visible in fullscreen) {%- endcomment -%}
	<button 
		class="product-gallery__fullscreen-close" 
		type="button" 
		data-gallery-fullscreen-close
		aria-label="{{ 'accessibility.close' | t | default: 'Close' }}"
	>
		{% render 'html-theme-icons', icon: 'close', size: 24 %}
	</button>
</div>

<style>
.product-gallery {
	--gallery-height: 80vh;
	--gallery-max: 800px;
	--thumb-size: 80px;
	
	position: sticky;
	top: calc(var(--header-height, 80px) + 1em);
	display: flex;
	flex-direction: column;
	gap: 0.5em;
}

/* Main slider */
.product-gallery__main {
	position: relative;
	width: 100%;
	aspect-ratio: 1;
	overflow: hidden;
}

/* Slides container */
.product-gallery__slides {
	display: flex;
	width: 100%;
	height: 100%;
	list-style: none;
	margin: 0;
	padding: 0;
}

/* Individual slide */
.product-gallery__slide {
	flex: 0 0 auto;
	width: auto;
	height: 100%;
	min-width: 0;
}

.product-gallery__slide .product-media__figure {
	height: 100%;
	width: auto;
	aspect-ratio: 2/3;
}

/* Desktop: full width slides */
@media (min-width: 960px) {
	.product-gallery__slide {
		flex: 0 0 100%;
		width: 100%;
	}
	
	.product-gallery__slide .product-media__figure {
		width: 100%;
		aspect-ratio: auto;
	}
}

/* Thumb slide */
.product-gallery__slide--thumb {
	flex: 0 0 var(--thumb-size);
	width: var(--thumb-size);
	height: var(--thumb-size);
	opacity: 0.5;
	cursor: pointer;
	transition: opacity 0.2s;
}

.product-gallery__slide--thumb:hover,
.swiper-slide-thumb-active {
	opacity: 1;
}

/* Thumbs container */
.product-gallery__thumbs {
	width: 100%;
	height: var(--thumb-size);
	overflow: hidden;
}

/* Navigation */
.product-gallery__nav {
	position: absolute;
	z-index: 2;
	display: flex;
	align-items: center;
	justify-content: center;
	width: 40px;
	height: 40px;
	background: rgba(255,255,255,0.9);
	border: 1px solid var(--theme-color-grey, #ddd);
	cursor: pointer;
	opacity: 0;
	transition: opacity 0.2s;
}

.product-gallery__main:hover .product-gallery__nav {
	opacity: 1;
}

.product-gallery__nav[disabled] { display: none; }

/* Horizontal mode: left/right */
.product-gallery__nav--prev { top: 50%; left: 0.5em; transform: translateY(-50%); }
.product-gallery__nav--next { top: 50%; right: 0.5em; transform: translateY(-50%); }

/* Vertical mode (via Swiper class): top/bottom with rotated icons */
.swiper-vertical .product-gallery__nav--prev {
	top: 0.5em;
	left: 50%;
	right: auto;
	transform: translateX(-50%) rotate(90deg);
}

.swiper-vertical .product-gallery__nav--next {
	top: auto;
	bottom: 0.5em;
	left: 50%;
	right: auto;
	transform: translateX(-50%) rotate(90deg);
}

/* Media figure (from html-product-media) */
.product-gallery .product-media__figure {
	width: 100%;
	height: 100%;
	margin: 0;
}

.product-gallery .product-media__picture {
	display: block;
	width: 100%;
	height: 100%;
}

.product-gallery .product-media__img {
	width: 100%;
	height: 100%;
	object-fit: contain;
}

.product-gallery__slide--thumb .product-media__img {
	object-fit: cover;
}

/* Desktop: horizontal layout */
@media (min-width: 960px) {
	.product-gallery {
		flex-direction: row;
		height: min(var(--gallery-height), var(--gallery-max));
	}
	
	.product-gallery__main {
		order: 1;
		flex: 1;
		aspect-ratio: auto;
		height: 100%;
	}
	
	.product-gallery__thumbs {
		order: 0;
		flex: 0 0 var(--thumb-size);
		width: var(--thumb-size);
		height: 100%;
	}
	
	.product-gallery__slide--thumb {
		flex: 0 0 var(--thumb-size);
		width: var(--thumb-size);
	}
}

/* ============================================
   FULLSCREEN BUTTON
   ============================================ */
.product-gallery__fullscreen-btn {
	position: absolute;
	z-index: 3;
	right: 0.75em;
	bottom: 0.75em;
	display: flex;
	align-items: center;
	justify-content: center;
	width: 40px;
	height: 40px;
	background: rgba(255, 255, 255, 0.95);
	border: 1px solid var(--theme-color-grey, #ddd);
	border-radius: 4px;
	cursor: pointer;
	transition: background-color 0.2s;
}

.product-gallery__fullscreen-btn:hover {
	background: #fff;
}

/* ============================================
   SHARE BUTTON
   ============================================ */
.product-gallery__share-btn {
	position: absolute;
	z-index: 3;
	right: 0.75em;
	bottom: calc(0.75em + 48px);
	display: flex;
	align-items: center;
	justify-content: center;
	width: 40px;
	height: 40px;
	background: rgba(255, 255, 255, 0.95);
	border: 1px solid var(--theme-color-grey, #ddd);
	border-radius: 4px;
	cursor: pointer;
	transition: background-color 0.2s;
}

.product-gallery__share-btn:hover {
	background: #fff;
}

/* Hide share button in fullscreen */
.product-gallery.is-fullscreen .product-gallery__share-btn {
	display: none;
}

/* ============================================
   FULLSCREEN CLOSE BUTTON (hidden by default)
   ============================================ */
.product-gallery__fullscreen-close {
	display: none;
}

/* ============================================
   BODY CLASS: suppress header z-index
   ============================================ */
body.gallery-fullscreen-open .shopify-section-header,
body.gallery-fullscreen-open [class*="header"],
body.gallery-fullscreen-open header {
	z-index: 0 !important;
}

/* ============================================
   FULLSCREEN MODE
   ============================================ */
.product-gallery.is-fullscreen {
	position: fixed;
	inset: 0;
	z-index: 9999999995;
	background: rgba(0, 0, 0, 0.95);
	padding: 1em;
	height: 100vh;
	height: 100dvh;
	max-height: none;
	top: 0;
	
	/* Altijd horizontal layout in fullscreen */
	flex-direction: row;
	gap: 1em;
}

/* Fullscreen: main slider neemt resterende ruimte */
.product-gallery.is-fullscreen .product-gallery__main {
	order: 1;
	flex: 1;
	aspect-ratio: auto;
	height: 100%;
	width: auto;
}

/* Fullscreen: thumbs verticaal links, volledige hoogte */
.product-gallery.is-fullscreen .product-gallery__thumbs {
	order: 0;
	flex: 0 0 var(--thumb-size);
	width: var(--thumb-size);
	height: 100%;
}

/* Fullscreen: main slides 100% width */
.product-gallery.is-fullscreen .product-gallery__slide {
	flex: 0 0 100%;
	width: 100%;
}

.product-gallery.is-fullscreen .product-gallery__slide .product-media__figure {
	width: 100%;
	height: 100%;
	aspect-ratio: auto;
}

.product-gallery.is-fullscreen .product-media__img {
	object-fit: contain;
}

/* Fullscreen: thumb slides */
.product-gallery.is-fullscreen .product-gallery__slide--thumb {
	flex: 0 0 var(--thumb-size);
	width: var(--thumb-size);
	height: var(--thumb-size);
}

/* Fullscreen: show close button */
.product-gallery.is-fullscreen .product-gallery__fullscreen-close {
	display: flex;
	position: absolute;
	z-index: 10;
	top: 1em;
	right: 1em;
	align-items: center;
	justify-content: center;
	width: 48px;
	height: 48px;
	background: rgba(255, 255, 255, 0.95);
	border: none;
	border-radius: 4px;
	cursor: pointer;
	transition: background-color 0.2s;
}

.product-gallery__fullscreen-close:hover {
	background: #fff;
}

/* Fullscreen: hide expand button */
.product-gallery.is-fullscreen .product-gallery__fullscreen-btn {
	display: none;
}

/* Fullscreen: navigation always visible */
.product-gallery.is-fullscreen .product-gallery__nav {
	opacity: 1;
	background: rgba(255, 255, 255, 0.9);
}

/* ============================================
   FULLSCREEN MOBILE: thumbs onderaan
   ============================================ */
@media (max-width: 749px) {
	.product-gallery.is-fullscreen {
		flex-direction: column;
	}
	
	.product-gallery.is-fullscreen .product-gallery__main {
		order: 0;
		flex: 1;
		height: auto;
	}
	
	.product-gallery.is-fullscreen .product-gallery__thumbs {
		order: 1;
		flex: 0 0 var(--thumb-size);
		width: 100%;
		height: var(--thumb-size);
	}
}
</style>

<script>
(function() {
	const gallery = document.querySelector('[data-product-gallery]');
	if (!gallery) return;

	// Fullscreen functionality
	const openBtn = gallery.querySelector('[data-gallery-fullscreen-open]');
	const closeBtn = gallery.querySelector('[data-gallery-fullscreen-close]');
	
	function openFullscreen() {
		gallery.classList.add('is-fullscreen');
		document.body.classList.add('gallery-fullscreen-open');
		document.body.style.overflow = 'hidden';
		
		gallery.querySelectorAll('.product-gallery__main img').forEach(img => {
			img.dataset.originalSizes = img.getAttribute('sizes');
			img.setAttribute('sizes', '100vw');
		});
		
		const swiperEl = gallery.querySelector('[data-swiper-id]');
		if (swiperEl && swiperEl.swiper) {
			setTimeout(() => swiperEl.swiper.update(), 100);
		}
		
		const thumbsEl = gallery.querySelector('[data-swiper-slave]');
		if (thumbsEl && thumbsEl.swiper) {
			setTimeout(() => thumbsEl.swiper.update(), 100);
		}
	}

	function closeFullscreen() {
		gallery.classList.remove('is-fullscreen');
		document.body.classList.remove('gallery-fullscreen-open');
		document.body.style.overflow = '';
		
		gallery.querySelectorAll('.product-gallery__main img').forEach(img => {
			if (img.dataset.originalSizes) {
				img.setAttribute('sizes', img.dataset.originalSizes);
			}
		});
		
		const swiperEl = gallery.querySelector('[data-swiper-id]');
		if (swiperEl && swiperEl.swiper) {
			setTimeout(() => swiperEl.swiper.update(), 100);
		}
		
		const thumbsEl = gallery.querySelector('[data-swiper-slave]');
		if (thumbsEl && thumbsEl.swiper) {
			setTimeout(() => thumbsEl.swiper.update(), 100);
		}
	}

	if (openBtn) openBtn.addEventListener('click', openFullscreen);
	if (closeBtn) closeBtn.addEventListener('click', closeFullscreen);

	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape' && gallery.classList.contains('is-fullscreen')) {
			closeFullscreen();
		}
	});

	gallery.addEventListener('click', (e) => {
		if (gallery.classList.contains('is-fullscreen') && e.target === gallery) {
			closeFullscreen();
		}
	});
})();
</script>
