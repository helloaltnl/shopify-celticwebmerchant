{%- liquid
  assign obj = object | default: collection | default: search
  assign sort_by = obj.sort_by | default: obj.default_sort_by
  assign drawer_id = 'filter-drawer-' | append: section_id
  
  comment
    Settings worden doorgegeven via render call als section.settings
  endcomment
  if settings.show_filter_counts == nil
    assign show_filter_counts = true
  else
    assign show_filter_counts = settings.show_filter_counts
  endif
  
  if settings.hide_empty_values == nil
    assign hide_empty_values = false
  else
    assign hide_empty_values = settings.hide_empty_values
  endif
  
  if settings.collapse_bar_mobile == nil
    assign collapse_bar_mobile = true
  else
    assign collapse_bar_mobile = settings.collapse_bar_mobile
  endif
  
  if settings.show_result_count == nil
    assign show_result_count = true
  else
    assign show_result_count = settings.show_result_count
  endif
-%}

<div class="product-filter__preview{% if collapse_bar_mobile %} collapse-mobile{% endif %}">
  <form id="BarFiltersForm-{{ section_id }}"
    class="facets facets--bar"
    data-facets
    method="get"
    action="{{ obj.url | default: routes.search_url }}">
    {%- if obj.terms -%}
      <input type="hidden" name="q" value="{{ obj.terms | escape }}">
      <input type="hidden" name="options[prefix]" value="last">
      <input type="hidden" name="type" value="product">
    {%- endif -%}

    <div class="facets__groups" role="group" aria-label="{{ 'collection.filtering.filters' | t }}">
      {%- for filter in obj.filters -%}
        {%- case filter.type -%}
          {%- when 'boolean','list' -%}
            <details class="facet" data-index="{{ forloop.index }}" data-param="{{ filter.param_name }}" role="group" aria-labelledby="facet-label-{{ filter.param_name }}-{{ section_id }}">
              <summary class="facet__summary">
                <span class="facet__name" id="facet-label-{{ filter.param_name }}-{{ section_id }}">{{ filter.label | escape }}</span>
                <span class="facet__icon">
                  {%- render 'html-theme-icons', icon: 'caret', size: 20 -%}
                </span>
              </summary>
              <fieldset class="facet__fieldset">
                <legend class="visually-hidden">{{ filter.label | escape }}</legend>
                <ul class="facet__values" role="list">
                  {%- for value in filter.values -%}
                    {%- if hide_empty_values and value.count == 0 and value.active == false -%}
                      {%- continue -%}
                    {%- endif -%}
                    {%- assign input_id = 'Bar-' | append: filter.param_name | escape | append: '-' | append: forloop.index0 | append: '-' | append: section_id -%}
                    <li data-value="{{ value.value | escape }}">
                      <label for="{{ input_id }}" class="facet__check{% if value.active %} is-active{% endif %}{% if value.count == 0 and value.active == false %} is-disabled{% endif %}">
                        <input type="checkbox"
                               id="{{ input_id }}"
                               name="{{ value.param_name }}"
                               value="{{ value.value }}"
                               class="facet__input" 
                               {% if value.active %}checked{% endif %}
                               {% if value.count == 0 and value.active == false %}disabled{% endif %}>
                        <span class="facet__text">{{ value.label | escape }}</span>
                        {%- if show_filter_counts -%}
                          <span class="facet__qty">({{ value.count }})</span>
                        {%- endif -%}
                      </label>
                    </li>
                  {%- endfor -%}
                </ul>
              </fieldset>
            </details>

          {%- when 'price_range' -%}
            {%- liquid
              assign min_value = filter.min_value.value | default: 0 | divided_by: 100.0
              assign max_value = filter.max_value.value | default: filter.range_max | divided_by: 100.0
              assign range_max = filter.range_max | divided_by: 100.0
            -%}
            <details class="facet facet--price" data-index="{{ forloop.index }}" data-param="{{ filter.param_name }}" role="group" aria-labelledby="facet-label-{{ filter.param_name }}-{{ section_id }}">
              <summary class="facet__summary">
                <span class="facet__name" id="facet-label-{{ filter.param_name }}-{{ section_id }}">{{ filter.label | escape }}</span>
                <span class="facet__icon">
                  {%- render 'html-theme-icons', icon: 'caret', size: 20 -%}
                </span>
              </summary>
              <fieldset class="facet__fieldset">
                <div class="facet__price-range" data-price-range>
                  <div class="facet__price-slider">
                    <input 
                      type="range" 
                      class="facet__range facet__range--min" 
                      min="0" 
                      max="{{ range_max | ceil }}" 
                      step="1" 
                      value="{{ min_value | floor }}"
                      data-range-min
                    >
                    <input 
                      type="range" 
                      class="facet__range facet__range--max" 
                      min="0" 
                      max="{{ range_max | ceil }}" 
                      step="1" 
                      value="{{ max_value | ceil }}"
                      data-range-max
                    >
                  </div>
                  <div class="facet__price-inputs">
                    <div class="facet__price-field">
                      <label class="facet__price-label" for="Bar-{{ filter.label | handle }}-GTE-{{ section_id }}">{{ 'collection.filtering.from' | t }}</label>
                      <div class="facet__price-input-wrap">
                        <span class="facet__price-currency">{{ cart.currency.symbol }}</span>
                        <input 
                          class="facet__price-input" 
                          name="{{ filter.min_value.param_name }}" 
                          id="Bar-{{ filter.label | handle }}-GTE-{{ section_id }}" 
                          type="text" 
                          inputmode="decimal" 
                          placeholder="0" 
                          value="{% if filter.min_value.value %}{{ min_value | floor }}{% endif %}"
                          data-input-min
                        >
                      </div>
                    </div>
                    <div class="facet__price-field">
                      <label class="facet__price-label" for="Bar-{{ filter.label | handle }}-LTE-{{ section_id }}">{{ 'collection.filtering.to' | t }}</label>
                      <div class="facet__price-input-wrap">
                        <span class="facet__price-currency">{{ cart.currency.symbol }}</span>
                        <input 
                          class="facet__price-input" 
                          name="{{ filter.max_value.param_name }}" 
                          id="Bar-{{ filter.label | handle }}-LTE-{{ section_id }}" 
                          type="text" 
                          inputmode="decimal" 
                          placeholder="{{ range_max | ceil }}" 
                          value="{% if filter.max_value.value %}{{ max_value | ceil }}{% endif %}"
                          data-input-max
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </fieldset>
            </details>
        {%- endcase -%}
      {%- endfor -%}
    </div>

    {%- if show_result_count -%}
      {%- liquid
        comment
          For search: use results_count for total (not paginated .size)
        endcomment
        if search
          assign result_count = search.results_count
        elsif obj.products_count
          assign result_count = obj.products_count
        else
          assign result_count = 0
        endif
      -%}
      <span class="facets__resultcount" data-facets-resultcount aria-live="polite">
        {{ 'collection.filtering.results' | t: count: result_count }}
      </span>
    {%- endif -%}

    {%- if settings.show_sort and obj.sort_options and obj.sort_options.size > 0 -%}
      <nav class="facets__sort facets__sort--preview">
        <label class="visually-hidden" for="SortBy-{{ section_id }}">{{ 'collection.sorting.label' | t }}</label>
        <select id="SortBy-{{ section_id }}" name="sort_by" class="select">
          {%- for option in obj.sort_options -%}
            <option value="{{ option.value | escape }}"{% if option.value == sort_by %} selected{% endif %}>
              {{ option.name | escape }}
            </option>
          {%- endfor -%}
        </select>
      </nav>
    {%- endif -%}
    
    <noscript><button class="button" type="submit">{{ 'collection.filtering.apply' | t }}</button></noscript>
  </form>

  {%- if obj.filters.size > 0 -%}
    <button 
      type="button"
      class="product-filter__open"
      data-drawer-trigger="{{ drawer_id }}"
      aria-haspopup="dialog"
    >
      {%- render 'html-theme-icons', icon: 'filter', size: 20 -%}
      <span>{{ 'collection.filtering.button' | t }}</span>
    </button>
  {%- endif -%}
</div>

<style>
  /* Preview filters bar */
  .product-filter__preview {
    display: flex;
    flex-wrap: nowrap;
    align-items: flex-start;
    gap: 1rem;
    width: 100%;
    max-width: 100%;
    position: relative;
    z-index: var(--theme-z-dropdown);
  }

  .product-filter__preview > .facets {
    flex: 1 1 auto;
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    width: 100%;
    max-width: 100%;
    position: relative;
    gap: 0.5rem;
  }

  .product-filter__preview .facets__groups {
    flex: 1 1 128px;
    display: flex;
    flex-wrap: nowrap;
    gap: 0.4rem;
    padding-top:0.2em;
  }

  .product-filter__preview .facets__groups .facet {
    flex: 0 0 auto;
    min-width: min-content;
    position: relative;
  }

  .product-filter__preview .facets__groups .facet .facet__summary {
    display: inline-flex;
    flex-direction: row;
    flex-wrap: nowrap;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 0.5rem;
    background-color: #fff;
    color: var(--theme-color-blue);
    font-family: inherit;
    font-size: inherit;
    cursor: pointer;
    list-style: none;
  }

  .product-filter__preview .facets__groups .facet .facet__summary::-webkit-details-marker {
    display: none;
  }

  .product-filter__preview .facets__groups .facet .facet__name {
    font-weight: 500;
    letter-spacing: -0.02em;
  }

  .product-filter__preview .facets__groups .facet .facet__icon {
    width: 1rem;
    height: 1rem;
    line-height: 1;
    transition: transform 200ms ease;
  }

  .product-filter__preview .facets__groups .facet[open] .facet__icon {
    transform: rotate(180deg);
  }

  .product-filter__preview .facets__groups .facet .facet__fieldset {
    position: absolute;
    left: 0;
    top: 100%;
    width: min(calc(100vw - 4rem), 15rem);
    max-height: 420px;
    overflow: hidden;
    overflow-y: auto;
    border: none;
    padding: 1rem;
    margin: 0;
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .product-filter__preview .facets__groups .facet .facet__values {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .product-filter__preview .facets__groups .facet .facet__check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0;
    cursor: pointer;
  }

  .product-filter__preview .facets__groups .facet .facet__check input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
    border: 1px solid #333;
    border-radius: 2px;
    accent-color: var(--theme-color-blue);
  }

  .product-filter__preview .facets__groups .facet .facet__check.is-disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .product-filter__preview .facets__groups .facet .facet__text {
    flex: 1; line-height: 1.2em;
  }

  .product-filter__preview .facets__groups .facet .facet__qty {
    opacity: 0.6;
    font-size: 0.875rem;
  }

  .product-filter__preview .facets__groups .facet.facet--hidden {
    display: none !important;
  }

  .product-filter__preview .facets__resultcount {
    flex: 0 0 auto;
    align-self: center;
    font-size: 0.875rem;
    opacity: 0.7;
    white-space: nowrap;
  }

  .product-filter__preview .facets__sort {
    flex: 0 0 196px;
    min-width: min-content;
    overflow: hidden;
  }

  .product-filter__open {
    flex: 0 0 auto;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6em 1rem;
    background-color: var(--theme-color-blue);
    color: var(--theme-color-white, #fff);
    border: none;
    font-family: inherit;
    font-size: inherit;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 200ms ease;
  }

  .product-filter__open:hover {
    opacity: 0.9;
  }

  .product-filter__open span {
    white-space: nowrap;
  }

  /* Mobile: collapse bar */
  .product-filter__preview.collapse-mobile > .facets .facets__groups {
    display: none !important;
  }

  .product-filter__preview.collapse-mobile > .facets .facets__resultcount {
    order: 2;
  }

  .product-filter__preview.collapse-mobile > .facets .facets__sort {
    order: 1;
  }

  .product-filter__preview.collapse-mobile .product-filter__open span {
    display: none;
  }

  .product-filter__preview.collapse-mobile .product-filter__open {
    padding: 0.625rem 0.75rem;
    background-color: var(--theme-color-blue);
    color: var(--theme-color-white, #fff);
  }

  @media only screen and (max-width: 23.75em) {
    .product-filter__preview.collapse-mobile > .facets .facets__resultcount {
      display: none;
    }
  }

  @media only screen and (min-width: 641px) {
    .product-filter__preview.collapse-mobile > .facets .facets__groups {
      display: flex !important;
    }

    .product-filter__preview.collapse-mobile > .facets .facets__resultcount {
      order: unset;
    }

    .product-filter__preview.collapse-mobile > .facets .facets__sort {
      order: unset;
    }

    .product-filter__preview.collapse-mobile .product-filter__open span {
      display: inline;
    }

    .product-filter__preview.collapse-mobile .product-filter__open {
      padding: 0.6em 1rem;
    }
  }

  /* Price range filter */
  .facet--price .facet__fieldset {
    width: min(calc(100vw - 4rem), 16rem);
    padding: 1.25rem;
  }

  .facet__price-range {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  /* Dual range slider */
  .facet__price-slider {
    position: relative;
    height: 1.25rem;
    display: flex;
    align-items: center;
    padding: 0 0.5rem;
  }

  .facet__price-slider::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    right: 0.5rem;
    height: 4px;
    background: var(--theme-color-grey, #e5e5e5);
    border-radius: 2px;
  }

  .facet__range {
    position: absolute;
    left: 0;
    right: 0;
    width: 100%;
    height: 1.25rem;
    background: transparent;
    pointer-events: none;
    -webkit-appearance: none;
    appearance: none;
    margin: 0;
  }

  .facet__range::-webkit-slider-runnable-track {
    height: 4px;
    background: transparent;
    border-radius: 2px;
  }

  .facet__range::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 1.125rem;
    height: 1.125rem;
    background: var(--theme-color-blue, #1a1a1a);
    border-radius: 50%;
    cursor: pointer;
    pointer-events: auto;
    margin-top: -7px;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .facet__range::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  .facet__range::-moz-range-track {
    height: 4px;
    background: transparent;
    border-radius: 2px;
  }

  .facet__range::-moz-range-thumb {
    width: 1.125rem;
    height: 1.125rem;
    background: var(--theme-color-blue, #1a1a1a);
    border-radius: 50%;
    cursor: pointer;
    pointer-events: auto;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .facet__range::-moz-range-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  /* Price inputs row */
  .facet__price-inputs {
    display: flex;
    flex-wrap: nowrap;
    align-items: flex-end;
    gap: 0.75rem;
  }

  .facet__price-field {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .facet__price-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--theme-color-foreground-subtle, #666);
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }

  .facet__price-input-wrap {
    display: flex;
    flex-wrap: nowrap;
    align-items: stretch;
    border: 1px solid var(--theme-color-border, #ddd);
    border-radius: 4px;
    overflow: hidden;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
  }

  .facet__price-input-wrap:focus-within {
    border-color: var(--theme-color-blue, #1a1a1a);
    box-shadow: 0 0 0 2px rgba(26, 26, 26, 0.1);
  }

  .facet__price-currency {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 0.4em !important;
    background: var(--theme-color-grey, #f5f5f5);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--theme-color-foreground-subtle, #666);
    border-right: 1px solid var(--theme-color-border, #ddd);
  }

  .facet__price-input {
    flex: 1;
    min-width: 0;
    width: 100%;
    padding: 0.2em 0.4em !important;
    border: none;
    font-size: 0.9375rem;
    font-family: inherit;
    text-align: right;
    background: transparent;
  }

  .facet__price-input:focus {
    outline: none;
  }

  .facet__price-input::placeholder {
    color: var(--theme-color-foreground-subtle, #999);
  }
</style>
