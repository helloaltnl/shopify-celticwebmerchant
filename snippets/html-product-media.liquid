{%- comment -%}
  Snippet: html-product-media
  Params:
    product : Product object (voor alt-fallback)
    media   : Product media object (verplicht-ish; we vangen ontbrekend netjes af)
    alt     : Image description (fallback product)
    mode    : 'main' | 'thumb' (optioneel; default 'main')
    img_w   : Number basisbreedte voor srcset (default 800)
    loading : 'lazy' | 'eager' (default 'lazy')
{%- endcomment -%}

{%- assign p = product -%}
{%- assign mode = mode | default: 'main' -%}
{%- assign loading = loading | default: 'lazy' -%}
{%- assign zoom = zoom | default: false -%}

{%- assign media_type = media.media_type | default: 'none' -%}
{%- assign type_class = media_type | replace: '_','-' -%}

{%- comment %}-------------------- RATIO --------------------{%- endcomment -%}
{%- assign ratio = media.aspect_ratio -%}
{%- if ratio == blank or ratio == 0 -%}
  {%- assign fw = media.preview_image.width  | default: media.width  -%}
  {%- assign fh = media.preview_image.height | default: media.height -%}
  {%- if fw and fh and fh > 0 -%}
    {%- assign ratio = fw | times: 1.0 | divided_by: fh -%}
  {%- else -%}
    {%- assign ratio = 1 -%}
  {%- endif -%}
{%- endif -%}

{%- comment %}-------------------- WIDTHS/HEIGHTS --------------------{%- endcomment -%}
{%- assign w1 = img_w | default: 800 | plus: 0 -%}
{%- assign w2 = w1 | times: 1.5 | round -%}
{%- assign w3 = w1 | times: 2 | round -%}

{%- assign h1 = w1 | divided_by: ratio | round -%}
{%- assign h2 = w2 | divided_by: ratio | round -%}
{%- assign h3 = w3 | divided_by: ratio | round -%}

{%- assign alt = media.alt | default: p.title | default: 'Media' -%}

<figure
  class="product-media__figure is-media-{{ type_class }} is-aspect-{% if ratio > 1 %}landscape{% elsif ratio < 1 %}portrait{% else %}square{% endif %}{% if mode == 'thumb' %} product-media__figure--thumb{% endif %}"
  style="--media-aspect-ratio: {{ ratio | round: 3 }};">
  {%- case media_type -%}

    {%- when 'image' -%}
      <picture class="product-media__picture">
        <source
          srcset="
            {{ media | image_url: width: w1, height: h1, format: 'webp', crop: 'center' }} {{ w1 }}w,
            {{ media | image_url: width: w2, height: h2, format: 'webp', crop: 'center' }} {{ w2 }}w,
            {{ media | image_url: width: w3, height: h3, format: 'webp', crop: 'center' }} {{ w3 }}w"
          type="image/webp"
          sizes="(min-width: 1200px) {{ w1 }}px, (min-width: 768px) {{ w1 | times: 0.8 | round }}px, 100vw" />
        <img
          class="product-media__img"
          src="{{ media | image_url: width: w1, height: h1, crop: 'center' }}"
          srcset="
            {{ media | image_url: width: w1, height: h1, crop: 'center' }} {{ w1 }}w,
            {{ media | image_url: width: w2, height: h2, crop: 'center' }} {{ w2 }}w,
            {{ media | image_url: width: w3, height: h3, crop: 'center' }} {{ w3 }}w"
          sizes="(min-width: 1200px) {{ w1 }}px, (min-width: 768px) {{ w1 | times: 0.8 | round }}px, 100vw"
          alt="{{ alt | escape }}"
          loading="{{ loading }}"
          width="{{ w1 }}"
          height="{{ h1 }}" />
      </picture>

    {%- when 'video' -%}
      {%- if mode == 'thumb' -%}
        {%- if media.preview_image -%}
          <picture class="product-media__picture">
            <source
              srcset="
                {{ media.preview_image | image_url: width: w1, height: h1, format: 'webp', crop: 'center' }} {{ w1 }}w,
                {{ media.preview_image | image_url: width: w2, height: h2, format: 'webp', crop: 'center' }} {{ w2 }}w,
                {{ media.preview_image | image_url: width: w3, height: h3, format: 'webp', crop: 'center' }} {{ w3 }}w"
              type="image/webp"
              sizes="(min-width: 1200px) {{ w1 }}px, (min-width: 768px) {{ w1 | times: 0.8 | round }}px, 100vw" />
            <img
              class="product-media__img"
              src="{{ media.preview_image | image_url: width: w1, height: h1, crop: 'center' }}"
              srcset="
                {{ media.preview_image | image_url: width: w1, height: h1, crop: 'center' }} {{ w1 }}w,
                {{ media.preview_image | image_url: width: w2, height: h2, crop: 'center' }} {{ w2 }}w,
                {{ media.preview_image | image_url: width: w3, height: h3, crop: 'center' }} {{ w3 }}w"
              sizes="(min-width: 1200px) {{ w1 }}px, (min-width: 768px) {{ w1 | times: 0.8 | round }}px, 100vw"
              alt="{{ alt | escape }}"
              loading="{{ loading }}"
              width="{{ w1 }}"
              height="{{ h1 }}" />
          </picture>
        {%- else -%}
          <div class="product-media__fallback">Video</div>
        {%- endif -%}
      {%- else -%}
        <button class="product-media__play" type="button" aria-label="{{ 'product.media.play_video' | t }}"><span aria-hidden="true">â–¶</span></button>
        <video
          class="product-media__video"
          preload="metadata"
          playsinline
          poster="{% if media.preview_image %}{{ media.preview_image | image_url: width: w1, height: h1, crop: 'center' }}{% endif %}"
          controlslist="nodownload"
          {% if loading == 'lazy' %}loading="lazy"{% endif %}>
          {%- for source in media.sources -%}
            <source src="{{ source.url }}" type="{{ source.mime_type }}">
          {%- endfor -%}
          {{ 'sections.video.load_error' | t | default: 'Your browser does not support the video tag.' }}
        </video>
      {%- endif -%}

    {%- when 'external_video' -%}
      {%- if media.preview_image -%}
        <picture class="product-media__picture">
          <source
            srcset="
              {{ media.preview_image | image_url: width: w1, height: h1, format: 'webp', crop: 'center' }} {{ w1 }}w,
              {{ media.preview_image | image_url: width: w2, height: h2, format: 'webp', crop: 'center' }} {{ w2 }}w,
              {{ media.preview_image | image_url: width: w3, height: h3, format: 'webp', crop: 'center' }} {{ w3 }}w"
            type="image/webp"
            sizes="(min-width: 1200px) {{ w1 }}px, (min-width: 768px) {{ w1 | times: 0.8 | round }}px, 100vw" />
          <img
            class="product-media__img"
            src="{{ media.preview_image | image_url: width: w1, height: h1, crop: 'center' }}"
            srcset="
              {{ media.preview_image | image_url: width: w1, height: h1, crop: 'center' }} {{ w1 }}w,
              {{ media.preview_image | image_url: width: w2, height: h2, crop: 'center' }} {{ w2 }}w,
              {{ media.preview_image | image_url: width: w3, height: h3, crop: 'center' }} {{ w3 }}w"
            sizes="(min-width: 1200px) {{ w1 }}px, (min-width: 768px) {{ w1 | times: 0.8 | round }}px, 100vw"
            alt="{{ alt | escape }}"
            loading="{{ loading }}"
            width="{{ w1 }}"
            height="{{ h1 }}" />
        </picture>
      {%- else -%}
        <div class="product-media__fallback">External video</div>
      {%- endif -%}

    {%- when 'model' -%}
      {%- if media.preview_image -%}
        <picture class="product-media__picture">
          <source
            srcset="
              {{ media.preview_image | image_url: width: w1, height: h1, format: 'webp', crop: 'center' }} {{ w1 }}w,
              {{ media.preview_image | image_url: width: w2, height: h2, format: 'webp', crop: 'center' }} {{ w2 }}w,
              {{ media.preview_image | image_url: width: w3, height: h3, format: 'webp', crop: 'center' }} {{ w3 }}w"
            type="image/webp"
            sizes="(min-width: 1200px) {{ w1 }}px, (min-width: 768px) {{ w1 | times: 0.8 | round }}px, 100vw" />
          <img
            class="product-media__img"
            src="{{ media.preview_image | image_url: width: w1, height: h1, crop: 'center' }}"
            srcset="
              {{ media.preview_image | image_url: width: w1, height: h1, crop: 'center' }} {{ w1 }}w,
              {{ media.preview_image | image_url: width: w2, height: h2, crop: 'center' }} {{ w2 }}w,
              {{ media.preview_image | image_url: width: w3, height: h3, crop: 'center' }} {{ w3 }}w"
            sizes="(min-width: 1200px) {{ w1 }}px, (min-width: 768px) {{ w1 | times: 0.8 | round }}px, 100vw"
            alt="{{ alt | escape }}"
            loading="{{ loading }}"
            width="{{ w1 }}"
            height="{{ h1 }}" />
        </picture>
      {%- else -%}
        <div class="product-media__fallback">3D</div>
      {%- endif -%}

    {%- else -%}
      <div class="product-media__fallback">Media</div>
  {%- endcase -%}
</figure>
