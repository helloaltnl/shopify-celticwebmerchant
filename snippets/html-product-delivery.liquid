{%- comment -%}
  ============================================================================
  HTML-PRODUCT-DELIVERY
  ============================================================================
  Displays delivery time based on product stock status and delivery references.

  PARAMETERS:
  - product: {Object} Product object (required)
  - variant: {Object} Product variant (optional, overrides product)
  - show: {Boolean} Whether to render (default: true)

  METAFIELDS:
  - product.metafields.custom.product-delivery-references: List of delivery-reference
    - Each delivery-reference has:
      - type: Metaobject reference to delivery-reference-type
        - type.value.condition: Stock condition key (see table below)
      - title: The message to display

  STOCK TYPES (matches html-product-stock):
  | Type                   | Delivery shown | Typical message           |
  |------------------------|----------------|---------------------------|
  | in-stock               | ✓              | "Delivered in 2-3 days"   |
  | in-stock-backorder     | ✓              | "Delivered in 2-3 days"   |
  | low-in-stock           | ✓              | "Delivered in 2-3 days"   |
  | low-in-stock-backorder | ✓              | "Delivered in 2-3 days"   |
  | out-of-stock           | ✗              | (nothing shown)           |
  | out-of-stock-backorder | ✓              | "Delivered in 2-4 weeks"  |
  | no-inventory           | ✓              | "Delivered in 2-3 days"   |

  METAFIELD CONDITIONS:
  - 'in-stock': Used for in-stock, in-stock-backorder, low-in-stock, low-in-stock-backorder, no-inventory
  - 'out-of-stock': Used for out-of-stock-backorder (longer delivery time)

  USAGE:
  {% render 'html-product-delivery', product: product %}
  {% render 'html-product-delivery', product: product, show: true %}
  ============================================================================
{%- endcomment -%}

{%- liquid
  assign show = show | default: true
  assign delivery_refs = product.metafields.custom['product-delivery-references'].value
-%}

{%- if show and delivery_refs != blank -%}
  {%- liquid
    # Get threshold from theme settings
    assign low_stock_threshold = settings.stock_low_threshold | default: 3

    # Determine which variant to use
    if variant
      assign v = variant
    else
      assign v = product.selected_or_first_available_variant | default: product.variants.first
    endif

    # Exit if no variant
    unless v
      break
    endunless

    # Determine inventory status
    assign has_inventory = false
    if v.inventory_management != blank
      assign has_inventory = true
    endif
    
    assign allows_backorder = false
    if v.inventory_policy == 'continue'
      assign allows_backorder = true
    endif
    
    assign quantity = v.inventory_quantity | default: 0
    
    assign is_low_stock = false
    if quantity <= low_stock_threshold and quantity > 0
      assign is_low_stock = true
    endif

    # Determine stock_type (same logic as html-product-stock)
    if has_inventory == false
      assign stock_type = 'no-inventory'
    elsif quantity <= 0
      if allows_backorder
        assign stock_type = 'out-of-stock-backorder'
      else
        assign stock_type = 'out-of-stock'
      endif
    elsif is_low_stock
      if allows_backorder
        assign stock_type = 'low-in-stock-backorder'
      else
        assign stock_type = 'low-in-stock'
      endif
    else
      if allows_backorder
        assign stock_type = 'in-stock-backorder'
      else
        assign stock_type = 'in-stock'
      endif
    endif

    # Parse delivery references into lookup
    assign in_stock_message = ''
    assign out_of_stock_message = ''
    
    for ref in delivery_refs
      assign ref_condition = ref.type.value.condition
      assign ref_title = ref.title.value
      
      case ref_condition
        when 'in-stock'
          assign in_stock_message = ref_title
        when 'out-of-stock'
          assign out_of_stock_message = ref_title
      endcase
    endfor

    # Select delivery message based on stock_type
    assign delivery_message = ''
    assign delivery_class = ''
    
    case stock_type
      when 'in-stock', 'in-stock-backorder', 'low-in-stock', 'low-in-stock-backorder', 'no-inventory'
        assign delivery_message = in_stock_message
        assign delivery_class = 'product-delivery--normal'
      when 'out-of-stock-backorder'
        assign delivery_message = out_of_stock_message | default: in_stock_message
        assign delivery_class = 'product-delivery--backorder'
      when 'out-of-stock'
        # No delivery message for out-of-stock (not backorderable)
        assign delivery_message = ''
    endcase
  -%}

  {%- if delivery_message != blank -%}
    <div class="product-delivery {{ delivery_class }}" data-delivery-type="{{ stock_type }}">
      <span class="product-delivery__message">{{ delivery_message }}</span>
    </div>
  {%- endif -%}
{%- endif -%}
