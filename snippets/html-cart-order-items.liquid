{% comment %}
  Renders cart items table
  
  Accepts:
  - cart: {Object} Cart object (required)
  - context: {String} Context ('page' | 'drawer' | 'preview') - default: 'page'
  - show_vendor: {Boolean} Show vendor name - default: false
  - compact: {Boolean} Use compact layout - default: false
  
  Usage:
  {% render 'html-cart-order-items', cart: cart, context: 'page', show_vendor: true %}
{% endcomment %}

{%- liquid
  assign context = context | default: 'page'
  assign show_vendor = show_vendor | default: false
  assign compact = compact | default: false
-%}

<style>
  .cart-items {
    width: 100%;
    border-collapse: collapse;
  }

  .cart-item {
    border-bottom: 1px solid rgba(var(--color-foreground), 0.08);
  }

  .cart-item__media {
    width: 120px;
    padding: 1.5rem 0;
  }

  .cart-item__image-container {
    position: relative;
    width: 100%;
    padding-bottom: 100%;
    overflow: hidden;
    border-radius: var(--border-radius);
  }

  .cart-item__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cart-item__details {
    padding: 1.5rem 1rem;
    vertical-align: top;
  }

  .cart-item__name {
    margin: 0 0 0.5rem;
    font-size: 1rem;
    font-weight: 500;
    line-height: 1.4;
  }

  .cart-item__vendor {
    margin: 0 0 0.25rem;
    font-size: 0.875rem;
    color: rgba(var(--color-foreground), 0.75);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .cart-item__price-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .cart-item__old-price {
    font-size: 0.875rem;
    color: rgba(var(--color-foreground), 0.55);
    text-decoration: line-through;
  }

  .cart-item__final-price {
    font-weight: 500;
    color: rgb(var(--color-foreground));
  }

  .cart-item__options {
    margin: 0.5rem 0 0;
    padding: 0;
    list-style: none;
  }

  .cart-item__option {
    display: flex;
    gap: 0.25rem;
    font-size: 0.875rem;
    color: rgba(var(--color-foreground), 0.75);
  }

  .cart-item__option dt {
    font-weight: 500;
  }

  .cart-item__discounts {
    margin: 0.5rem 0 0;
    padding: 0;
    list-style: none;
  }

  .cart-item__discount {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    color: rgb(var(--color-sale));
  }

  .cart-item__discount svg {
    width: 1rem;
    height: 1rem;
  }

  .cart-item__quantity {
    padding: 1.5rem 1rem;
    vertical-align: top;
  }

  .cart-item__totals {
    padding: 1.5rem 1rem;
    text-align: right;
    vertical-align: top;
  }

  .cart-item__error {
    margin-top: 0.5rem;
    padding: 0.5rem;
    font-size: 0.875rem;
    color: rgb(var(--color-error));
    background: rgba(var(--color-error), 0.1);
    border-radius: var(--border-radius);
    display: none;
  }

  .cart-item__error[style*="display: block"] {
    display: block;
  }

  /* Loading state */
  .cart-item.loading {
    opacity: 0.5;
    pointer-events: none;
  }

  /* Responsive */
  @media screen and (max-width: 749px) {
    .cart-item__media {
      width: 80px;
    }

    .cart-item__details,
    .cart-item__quantity,
    .cart-item__totals {
      padding: 1rem 0.5rem;
    }

    .small-hide {
      display: none;
    }
  }

  /* Compact mode for drawer/preview */
  {% if compact %}
  .cart-item__media {
    width: 80px;
  }

  .cart-item__details,
  .cart-item__quantity,
  .cart-item__totals {
    padding: 1rem 0.5rem;
    font-size: 0.875rem;
  }

  .cart-item__name {
    font-size: 0.875rem;
  }
  {% endif %}
</style>

{%- if cart.item_count > 0 -%}
  <table class="cart-items" role="table">
    <caption class="visually-hidden">
      {{ 'sections.cart.title' | t }}
    </caption>
    
    <thead>
      <tr>
        <th class="visually-hidden" colspan="2" scope="col">
          {{ 'sections.cart.headings.product' | t }}
        </th>
        {%- unless compact -%}
          <th class="medium-hide large-up-hide visually-hidden" colspan="1" scope="col">
            {{ 'sections.cart.headings.total' | t }}
          </th>
          <th class="small-hide visually-hidden" colspan="1" scope="col">
            {{ 'sections.cart.headings.quantity' | t }}
          </th>
        {%- endunless -%}
        <th class="{% if compact %}visually-hidden{% else %}small-hide{% endif %}" colspan="1" scope="col">
          {{ 'sections.cart.headings.total' | t }}
        </th>
      </tr>
    </thead>

    <tbody>
      {%- for item in cart.items -%}
        <tr 
          class="cart-item" 
          id="CartItem-{{ item.index | plus: 1 }}"
          data-cart-item
          data-line="{{ item.index | plus: 1 }}"
          data-variant-id="{{ item.variant.id }}"
        >
          {%- comment -%} Product Image {%- endcomment -%}
          <td class="cart-item__media">
            {%- if item.image -%}
              <a href="{{ item.url }}" class="cart-item__link" aria-hidden="true" tabindex="-1"> </a>
              <div class="cart-item__image-container gradient global-media-settings">
                <img
                  src="{{ item.image | image_url: width: 300 }}"
                  class="cart-item__image"
                  alt="{{ item.image.alt | escape }}"
                  loading="lazy"
                  width="150"
                  height="{{ 150 | divided_by: item.image.aspect_ratio | ceil }}"
                >
              </div>
            {%- endif -%}
          </td>

          {%- comment -%} Product Details {%- endcomment -%}
          <td class="cart-item__details">
            {%- if show_vendor and item.product.vendor != blank -%}
              <p class="cart-item__vendor">{{ item.product.vendor }}</p>
            {%- endif -%}

            <a href="{{ item.url }}" class="cart-item__name h4 break">
              {{- item.product.title | escape -}}
            </a>

            {%- comment -%} Price {%- endcomment -%}
            <div class="cart-item__price-wrapper">
              {%- if item.original_price != item.final_price -%}
                <s class="cart-item__old-price">
                  {{- item.original_price | money -}}
                </s>
                <strong class="cart-item__final-price">
                  {{ item.final_price | money }}
                </strong>
              {%- else -%}
                <span class="cart-item__price">
                  {{ item.original_price | money }}
                </span>
              {%- endif -%}
            </div>

            {%- comment -%} Variants & Properties {%- endcomment -%}
            {%- if item.product.has_only_default_variant == false
              or item.properties.size != 0
              or item.selling_plan_allocation != null
            -%}
              <dl class="cart-item__options">
                {%- if item.product.has_only_default_variant == false -%}
                  {%- for option in item.options_with_values -%}
                    <div class="cart-item__option">
                      <dt>{{ option.name }}:</dt>
                      <dd>{{ option.value }}</dd>
                    </div>
                  {%- endfor -%}
                {%- endif -%}

                {%- for property in item.properties -%}
                  {%- assign property_first_char = property.first | slice: 0 -%}
                  {%- if property.last != blank and property_first_char != '_' -%}
                    <div class="cart-item__option">
                      <dt>{{ property.first }}:</dt>
                      <dd>
                        {%- if property.last contains '/uploads/' -%}
                          <a href="{{ property.last }}" class="link" target="_blank">
                            {{ property.last | split: '/' | last }}
                          </a>
                        {%- else -%}
                          {{ property.last }}
                        {%- endif -%}
                      </dd>
                    </div>
                  {%- endif -%}
                {%- endfor -%}

                {%- if item.selling_plan_allocation != null -%}
                  <div class="cart-item__option">
                    <dd>{{ item.selling_plan_allocation.selling_plan.name }}</dd>
                  </div>
                {%- endif -%}
              </dl>
            {%- endif -%}

            {%- comment -%} Line-level Discounts {%- endcomment -%}
            {%- if item.line_level_discount_allocations.size > 0 -%}
              <ul class="cart-item__discounts">
                {%- for discount in item.line_level_discount_allocations -%}
                  <li class="cart-item__discount">
                    {{- 'icon-discount.svg' | inline_asset_content -}}
                    {{ discount.discount_application.title | escape }}
                  </li>
                {%- endfor -%}
              </ul>
            {%- endif -%}

            {%- comment -%} Unit Price {%- endcomment -%}
            {%- if item.variant.available and item.unit_price_measurement -%}
              <div class="cart-item__unit-price">
                {% render 'unit-price', 
                  price: item.unit_price, 
                  measurement: item.unit_price_measurement 
                %}
              </div>
            {%- endif -%}
          </td>

          {%- comment -%} Quantity Controls {%- endcomment -%}
          <td class="cart-item__quantity">
            <cart-quantity-input>
              <div class="quantity-wrapper">
                <button 
                  class="quantity__button" 
                  name="minus" 
                  type="button"
                  aria-label="{{ 'products.product.quantity.decrease' | t: product: item.product.title | escape }}"
                >
                  <span class="svg-wrapper">
                    {{- 'icon-minus.svg' | inline_asset_content -}}
                  </span>
                </button>
                
                <input
                  class="quantity__input"
                  type="number"
                  name="updates[]"
                  value="{{ item.quantity }}"
                  min="{{ item.variant.quantity_rule.min | default: 1 }}"
                  {% if item.variant.quantity_rule.max != null %}
                    max="{{ item.variant.quantity_rule.max }}"
                  {% endif %}
                  step="{{ item.variant.quantity_rule.increment | default: 1 }}"
                  data-line="{{ item.index | plus: 1 }}"
                  data-min="{{ item.variant.quantity_rule.min | default: 1 }}"
                  data-previous-value="{{ item.quantity }}"
                  aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                  id="Quantity-{{ item.index | plus: 1 }}"
                >
                
                <button 
                  class="quantity__button" 
                  name="plus" 
                  type="button"
                  aria-label="{{ 'products.product.quantity.increase' | t: product: item.product.title | escape }}"
                >
                  <span class="svg-wrapper">
                    {{- 'icon-plus.svg' | inline_asset_content -}}
                  </span>
                </button>
              </div>
              
              <cart-remove-button data-line="{{ item.index | plus: 1 }}">
                <button
                  type="button"
                  class="cart-remove-button"
                  aria-label="{{ 'sections.cart.remove_title' | t: title: item.title | escape }}"
                >
                  <span class="svg-wrapper">
                    {{- 'icon-remove.svg' | inline_asset_content -}}
                  </span>
                  <span class="cart-remove-button__text">
                    {{ 'sections.cart.remove' | t }}
                  </span>
                </button>
              </cart-remove-button>
            </cart-quantity-input>

            {%- comment -%} Error message {%- endcomment -%}
            <div class="cart-item__error" data-cart-item-error></div>
          </td>

          {%- comment -%} Line Total {%- endcomment -%}
          <td class="cart-item__totals {% unless compact %}small-hide{% endunless %}">
            <div class="cart-item__price-wrapper">
              {%- if item.original_line_price != item.final_line_price -%}
                <s class="cart-item__old-price">
                  {{ item.original_line_price | money }}
                </s>
                <strong class="cart-item__final-price">
                  {{ item.final_line_price | money }}
                </strong>
              {%- else -%}
                <span class="cart-item__price">
                  {{ item.original_line_price | money }}
                </span>
              {%- endif -%}
            </div>
          </td>
        </tr>
      {%- endfor -%}
    </tbody>
  </table>
{%- else -%}
  <div class="cart-items__empty">
    <p>{{ 'sections.cart.empty' | t }}</p>
    <a href="{{ routes.all_products_collection_url }}" class="button">
      {{ 'general.continue_shopping' | t }}
    </a>
  </div>
{%- endif -%}
