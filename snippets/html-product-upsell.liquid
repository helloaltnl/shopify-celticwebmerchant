{%- comment -%}
  ============================================================================
  HTML-PRODUCT-UPSELL
  ============================================================================
  Upsell products with checkbox add-to-cart functionality.
  
  PARAMETERS:
  - product: {Object} Product object (required)
  
  METAFIELDS:
  - product.metafields.custom['recommended-products']: List of variant references
  
  FEATURES:
  - Checkbox toggles add/remove from cart
  - Auto-syncs with current cart state on load
  - Shows variant image, title, and price
  ============================================================================
{%- endcomment -%}

{%- liquid
  assign p = product
  assign upsell_metafield = p.metafields.custom['recommended-products']
-%}

{%- if upsell_metafield != blank -%}
  {%- assign upsell_variants = upsell_metafield.value -%}
  
  <div class="product-upsell" data-fragment-skip="upsells" data-product-upsell>
    <p class="product-upsell__heading">
      <strong>{{ 'product.upsell_heading' | t }}</strong>
    </p>
    
    <ul class="product-upsell__list">
      {%- for variant in upsell_variants -%}
        {%- liquid
          assign upsell_product = variant.product
          assign upsell_image = variant.featured_image | default: upsell_product.featured_image
        -%}
        
        <li class="product-upsell__item">
          <label class="product-upsell__label">
            <input
              type="checkbox"
              class="product-upsell__checkbox"
              data-variant-id="{{ variant.id }}"
            >
            
            {%- if upsell_image -%}
              <figure class="product-upsell__image">
                <img
                  src="{{ upsell_image | image_url: width: 128 }}"
                  alt="{{ upsell_product.title | escape }}"
                  width="64"
                  height="64"
                  loading="lazy"
                >
              </figure>
            {%- endif -%}
            
            <span class="product-upsell__title">{{ variant.title }}</span>
            
            <span class="product-upsell__price">
              {%- render 'helper-price-formatted', amount: variant.price -%}
            </span>
          </label>
        </li>
      {%- endfor -%}
    </ul>
  </div>

  <style>
    .product-upsell {
      background-color: var(--theme-color-grey);
      padding: 1em;
      /* margins controlled by parent */
    }

    .product-upsell__heading {
      margin: 0 0 0.75em;
    }

    .product-upsell__list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }

    .product-upsell__label {
      display: flex;
      flex-wrap: nowrap;
      align-items: center;
      gap: 0.75em;
      cursor: pointer;
    }

    .product-upsell__checkbox {
      flex-shrink: 0;
      appearance: none;
      width: 1.25em;
      height: 1.25em;
      border: 2px solid var(--theme-color-blue);
      border-radius: 2px;
      background-color: #fff;
      cursor: pointer;
      transition: background-color 150ms ease;
    }

    .product-upsell__checkbox:checked {
      background-color: var(--theme-color-blue);
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M20.7,6.7l-11,11C9.5,17.9,9.3,18,9,18s-0.5-0.1-0.7-0.3l-5-5c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0L9,15.6L19.3,5.3c0.4-0.4,1-0.4,1.4,0S21.1,6.3,20.7,6.7z"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 1em;
    }

    .product-upsell__checkbox:focus-visible {
      outline: 2px solid var(--theme-color-blue);
      outline-offset: 2px;
    }

    .product-upsell__image {
      flex-shrink: 0;
      width: 3em;
      height: 3em;
      margin: 0;
    }

    .product-upsell__image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-upsell__title {
      flex-grow: 1;
      font-size: 0.9em;
    }

    .product-upsell__price {
      flex-shrink: 0;
      text-align: right;
      white-space: nowrap;
      font-weight: 500;
    }
  </style>

  <script>
    (function() {
      const container = document.querySelector('[data-product-upsell]');
      if (!container) return;

      const checkboxes = container.querySelectorAll('.product-upsell__checkbox');
      if (!checkboxes.length) return;

      // Sync checkboxes with current cart on load
      fetch('/cart.js', { headers: { 'Accept': 'application/json' } })
        .then(function(res) { return res.json(); })
        .then(function(cart) {
          var inCartIds = cart.items.map(function(item) { return item.variant_id; });
          
          checkboxes.forEach(function(cb) {
            var id = Number(cb.dataset.variantId);
            cb.checked = inCartIds.indexOf(id) !== -1;
          });
        })
        .catch(function(err) { console.error('Error fetching cart:', err); });

      // Handle checkbox changes
      checkboxes.forEach(function(cb) {
        cb.addEventListener('change', function(e) {
          var variantId = e.target.dataset.variantId;
          
          if (e.target.checked) {
            addToCart(variantId);
          } else {
            removeFromCart(variantId);
          }
        });
      });

      function addToCart(variantId) {
        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ id: Number(variantId), quantity: 1 })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          document.dispatchEvent(new CustomEvent('cart:updated', { detail: data }));
        })
        .catch(function(err) { console.error('Error adding upsell:', err); });
      }

      function removeFromCart(variantId) {
        fetch('/cart.js', { headers: { 'Accept': 'application/json' } })
          .then(function(res) { return res.json(); })
          .then(function(cart) {
            var index = -1;
            for (var i = 0; i < cart.items.length; i++) {
              if (cart.items[i].variant_id === Number(variantId)) {
                index = i;
                break;
              }
            }
            
            if (index === -1) return null;

            return fetch('/cart/change.js', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({ line: index + 1, quantity: 0 })
            });
          })
          .then(function(res) { return res ? res.json() : null; })
          .then(function(data) {
            if (data) {
              document.dispatchEvent(new CustomEvent('cart:updated', { detail: data }));
            }
          })
          .catch(function(err) { console.error('Error removing upsell:', err); });
      }
    })();
  </script>
{%- endif -%}
