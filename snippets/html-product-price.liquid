{%- comment -%}
============================================================================
HTML-PRODUCT-PRICE
============================================================================
Renders product price with optional compare-at price.

PARAMETERS:
- product: {Object} Product object (required)
- variant: {Object} Specific variant (optional, overrides selection logic)
- show: {Boolean} Whether to show price (default: true)
- from: {String} Variant selection mode (default: 'auto')
  - 'auto': selected_or_first_available_variant
  - 'first': first variant
  - 'first_available': first available variant
  - 'cheapest_available': cheapest available variant
- show_compare: {Boolean} Show compare-at price if higher (default: true)
- show_tax_notice: {Boolean} Show tax included/excluded notice (default: false)
- show_unit_price: {Boolean} Show unit price if available (default: true)
- class: {String} Additional CSS class (optional)
============================================================================
{%- endcomment -%}

{%- liquid
	assign show = show | default: true
	
	if show_compare == nil
		if settings.price_show_compare == nil
			assign show_compare = true
		else
			assign show_compare = settings.price_show_compare
		endif
	endif
	
	if show_tax_notice == nil
		if settings.price_show_tax_notice == nil
			assign show_tax_notice = false
		else
			assign show_tax_notice = settings.price_show_tax_notice
		endif
	endif
	
	assign show_unit_price = show_unit_price | default: true
	assign extra_class = class | default: ''
	assign currency_symbol = cart.currency.symbol | default: localization.country.currency.symbol | default: 'â‚¬'
-%}

{%- if show and product -%}
	{%- liquid
		assign v = variant
		if v == blank
			assign mode = from | default: 'auto'
			case mode
				when 'auto'
					assign v = product.selected_or_first_available_variant | default: product.variants.first
				when 'first'
					assign v = product.variants.first
				when 'first_available'
					for vv in product.variants
						if vv.available
							assign v = vv
							break
						endif
					endfor
					if v == blank
						assign v = product.variants.first
					endif
				when 'cheapest_available'
					assign min_price = nil
					for vv in product.variants
						if vv.available
							if min_price == nil or vv.price < min_price
								assign min_price = vv.price
								assign v = vv
							endif
						endif
					endfor
					if v == blank
						assign v = product.variants.first
					endif
				else
					assign v = product.selected_or_first_available_variant | default: product.variants.first
			endcase
		endif
	-%}

	{%- if v -%}
		<div class="product-price {{ extra_class }}">
			<span class="product-price__current" data-price>
				{%- liquid
					assign formatted = v.price | money_without_currency
					assign dec_sep = ''
					assign tail_comma = formatted | split: ',' | last
					if tail_comma != formatted and tail_comma.size == 2
						assign dec_sep = ','
					else
						assign tail_dot = formatted | split: '.' | last
						if tail_dot != formatted and tail_dot.size == 2
							assign dec_sep = '.'
						endif
					endif
					if dec_sep != ''
						assign before = formatted | split: dec_sep | first
						assign after = formatted | split: dec_sep | last
					else
						assign before = formatted
						assign after = '00'
						assign dec_sep = ','
					endif
				-%}
				<span class="price">
					<span class="valuta">{{ currency_symbol }}</span>
					<span class="before_seperator">{{ before }}</span>
					<span class="seperator">{{ dec_sep }}</span>
					<span class="after_seperator">{{ after }}</span>
				</span>
			</span>
			
			{%- if show_compare and v.compare_at_price and v.compare_at_price > v.price -%}
				<span class="product-price__compare" data-compare-at>
					{%- liquid
						assign formatted_compare = v.compare_at_price | money_without_currency
						assign dec_sep_compare = ''
						assign tail_comma_compare = formatted_compare | split: ',' | last
						if tail_comma_compare != formatted_compare and tail_comma_compare.size == 2
							assign dec_sep_compare = ','
						else
							assign tail_dot_compare = formatted_compare | split: '.' | last
							if tail_dot_compare != formatted_compare and tail_dot_compare.size == 2
								assign dec_sep_compare = '.'
							endif
						endif
						if dec_sep_compare != ''
							assign before_compare = formatted_compare | split: dec_sep_compare | first
							assign after_compare = formatted_compare | split: dec_sep_compare | last
						else
							assign before_compare = formatted_compare
							assign after_compare = '00'
							assign dec_sep_compare = ','
						endif
					-%}
					<span class="price">
						<span class="valuta">{{ currency_symbol }}</span>
						<span class="before_seperator">{{ before_compare }}</span>
						<span class="seperator">{{ dec_sep_compare }}</span>
						<span class="after_seperator">{{ after_compare }}</span>
					</span>
				</span>
			{%- endif -%}
			
			{%- if show_tax_notice -%}
				<span class="product-price__tax-notice">
					{%- if cart.taxes_included -%}
						{{ 'product.price.tax_included' | t }}
					{%- else -%}
						{{ 'product.price.tax_excluded' | t }}
					{%- endif -%}
				</span>
			{%- endif -%}
			
			{%- if show_unit_price and v.unit_price_measurement -%}
				<span class="product-price__unit">
					<span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
					{{ v.unit_price | money_with_currency }}/{{ v.unit_price_measurement.reference_value | default: 1 }}{{ v.unit_price_measurement.reference_unit }}
				</span>
			{%- endif -%}
		</div>
	{%- endif -%}
{%- endif -%}