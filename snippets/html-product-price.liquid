{%- comment -%}
  ============================================================================
  HTML-PRODUCT-PRICE
  ============================================================================
  Renders product price with optional compare-at price.

  PARAMETERS:
  - product: {Object} Product object (required)
  - variant: {Object} Specific variant (optional, overrides selection logic)
  - show: {Boolean} Whether to show price (default: true)
  - from: {String} Variant selection mode (default: 'auto')
    - 'auto': selected_or_first_available_variant
    - 'first': first variant
    - 'first_available': first available variant
    - 'cheapest_available': cheapest available variant
  - show_compare: {Boolean} Show compare-at price if higher (default: true)
  - show_tax_notice: {Boolean} Show tax included/excluded notice (default: false)
  - show_unit_price: {Boolean} Show unit price if available (default: true)
  - class: {String} Additional CSS class (optional)

  DEPENDENCIES:
  - helper-price-formatted snippet
  ============================================================================
{%- endcomment -%}

{%- liquid
  assign show = show | default: true
  
  # Handle show_compare - can't use default because false would be overwritten
  if show_compare == nil
    if settings.price_show_compare == nil
      assign show_compare = true
    else
      assign show_compare = settings.price_show_compare
    endif
  endif
  
  # Handle show_tax_notice - same pattern
  if show_tax_notice == nil
    if settings.price_show_tax_notice == nil
      assign show_tax_notice = false
    else
      assign show_tax_notice = settings.price_show_tax_notice
    endif
  endif
  
  assign show_unit_price = show_unit_price | default: true
  assign extra_class = class | default: ''
-%}

{%- if show and product -%}
  {%- liquid
    assign v = variant
    if v == blank
      assign mode = from | default: 'auto'
      case mode
        when 'auto'
          assign v = product.selected_or_first_available_variant | default: product.variants.first
        when 'first'
          assign v = product.variants.first
        when 'first_available'
          for vv in product.variants
            if vv.available
              assign v = vv
              break
            endif
          endfor
          if v == blank
            assign v = product.variants.first
          endif
        when 'cheapest_available'
          assign min_price = nil
          for vv in product.variants
            if vv.available
              if min_price == nil or vv.price < min_price
                assign min_price = vv.price
                assign v = vv
              endif
            endif
          endfor
          if v == blank
            assign v = product.variants.first
          endif
        else
          assign v = product.selected_or_first_available_variant | default: product.variants.first
      endcase
    endif
  -%}

  {%- if v -%}
    <div class="product-price {{ extra_class }}">
      <div class="product-price__row">
        <span class="product-price__current" data-price>
          {%- render 'helper-price-formatted', amount: v.price -%}
        </span>
        {%- if show_compare and v.compare_at_price and v.compare_at_price > v.price -%}
          <span class="product-price__compare" data-compare-at>
            {%- render 'helper-price-formatted', amount: v.compare_at_price -%}
          </span>
        {%- endif -%}
      </div>
      {%- if show_tax_notice -%}
        <span class="product-price__tax-notice">
          {%- if cart.taxes_included -%}
            {{ 'product.price.tax_included' | t }}
          {%- else -%}
            {{ 'product.price.tax_excluded' | t }}
          {%- endif -%}
        </span>
      {%- endif -%}
      {%- if show_unit_price and v.unit_price_measurement -%}
        <span class="product-price__unit">
          <span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
          {{ v.unit_price | money_with_currency }}/{{ v.unit_price_measurement.reference_value | default: 1 }}{{ v.unit_price_measurement.reference_unit }}
        </span>
      {%- endif -%}
    </div>
  {%- endif -%}
{%- endif -%}

<style>
  .product-price {
    display: flex;
    flex-direction: column;
    font-size: 0.8em;
  }

  .product-price__row {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0.5em;
  }

  .product-price__current {
    font-size: 1.8em;
    font-weight: 500;
    letter-spacing: var(--theme-letter-spacing);
  }

  .product-price__compare {
    font-size: 1.1em;
    opacity: 0.6;
    text-decoration: line-through;
  }

  .product-price__tax-notice,
  .product-price__unit {
    font-size: 0.9em;
    opacity: 0.6;
    margin-top: -0.2em;
  }
</style>
