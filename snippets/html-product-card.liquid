{%- comment -%}
  Product Card
  Accepts:
  - product: {Object} (required)
  - layout: {String} 'vertical' | 'horizontal' (default: 'vertical')
  - show_secondary_image: {Boolean} (default false)
  - show_vendor: {Boolean} (default false)
  - show_price: {Boolean} (default false)
  - show_stock: {Boolean} (default false)
  - show_delivery: {Boolean} (default false, requires metafields.ism_deliverydate.deliverydate )
  - show_rating: {Boolean} (default false, requires metafields.reviews)
  - show_badges: {Boolean} (default true)
  - show_volume_pricing: {Boolean} (default false, B2B feature)
  - quick_add: {Boolean} (default false)

  Note: Price and stock always use 'auto' (selected_or_first_available_variant)
  to match Shopify's automatic product URL linking.
{%- endcomment -%}

{%- assign p = product | default: card_product -%}
{%- if p and p != empty -%}
{%- liquid
  assign card_layout = layout | default: 'vertical'
  assign card_image_ratio = image_ratio | default: 'adapt'
  assign has_secondary_image = false
  if show_secondary_image and p.media[1]
    assign has_secondary_image = true
  endif
  
  comment
    For horizontal layout with adapt ratio, the image fills the height of the card
  endcomment
  if card_layout == 'horizontal' and card_image_ratio == 'adapt'
    assign aspect_ratio = 'auto'
    assign image_fill_height = true
  else
    assign image_fill_height = false
    case card_image_ratio
      when 'square'
        assign aspect_ratio = '1 / 1'
      when 'portrait'
        assign aspect_ratio = '2 / 3'
      when 'landscape'
        assign aspect_ratio = '3 / 2'
      else
        assign aspect_ratio = 'auto'
    endcase
  endif
-%}

  <div class="product-card product-card--{{ card_layout }}{% if image_fill_height %} product-card--image-fill{% endif %}{% if has_secondary_image %} product-card--has-secondary{% endif %}" style="--card-image-ratio: {{ aspect_ratio }};">
	<!-- Media -->
	<figure class="product-card__media">
		<a href="{{ p.url }}"> </a>
		<picture>
		{%- if p.featured_media -%}
		  {%- liquid
		    assign img = p.featured_media
		    assign img_alt = p.featured_media.alt | default: p.title | escape
		    assign loading_attr = 'lazy'
		    if lazy_load == false
		      assign loading_attr = 'eager'
		    endif
		  -%}
		  <img
			class="product-card__img"
			alt="{{ img_alt | escape }}"
			width="{{ img.width }}"
			height="{{ img.height }}"
			loading="{{ loading_attr }}"
			src="{{ img | image_url: width: 330 }}"
			srcset="
			  {{ img | image_url: width: 165  }} 165w,
			  {{ img | image_url: width: 330  }} 330w,
			  {{ img | image_url: width: 495  }} 495w,
			  {{ img | image_url: width: 660  }} 660w"
			sizes="(min-width: 990px) 25vw, (min-width: 750px) 33vw, 50vw"
		  />
		  {%- if has_secondary_image -%}
			{%- assign alt_second = p.media[1].alt | default: p.title | escape -%}
			<img
			  class="product-card__img product-card__img--secondary"
			  alt="{{ alt_second }}"
			  loading="lazy"
			  src="{{ p.media[1] | image_url: width: 330 }}"
			  srcset="
			    {{ p.media[1] | image_url: width: 165 }} 165w,
			    {{ p.media[1] | image_url: width: 330 }} 330w,
			    {{ p.media[1] | image_url: width: 495 }} 495w,
			    {{ p.media[1] | image_url: width: 660 }} 660w"
			  sizes="(min-width: 990px) 25vw, (min-width: 750px) 33vw, 50vw"
			/>
		  {%- endif -%}
		{%- else -%}
		  <div class="product-card__placeholder" aria-hidden="true"></div>
		{%- endif -%}
	   
		</picture>
	</figure>
	<!-- Content -->
	<div class="product-card__content">
	  {%- if show_rating and p.metafields.reviews.rating.value != blank -%}
		{%- assign rating = p.metafields.reviews.rating.value -%}
		<div class="product-card__rating">
		  ‚≠ê {{ rating.rating }} / {{ rating.scale_max }} ({{ rating.rating_count }})
		</div>
	  {%- endif -%}

	  {%- if show_vendor -%}
		<div class="product-card__vendor">{{ p.vendor }}</div>
	  {%- endif -%}

	  <h3 class="product-card__title">
		<a href="{{ p.url }}">{{ p.title | escape }}</a>
	  </h3>

	  {%- if show_price -%}
		{%- render 'html-product-price',
		  product: p,
		  show: show_price,
		  from: 'auto'
		-%}
	  {%- endif -%}

	  {%- comment -%} Volume Pricing (B2B) {%- endcomment -%}
	  {%- if show_volume_pricing and p.quantity_price_breaks_configured? -%}
		{%- assign variant = p.selected_or_first_available_variant -%}
		{%- if variant.quantity_price_breaks.size > 0 -%}
		  <div class="product-card__volume-pricing">
			<details class="volume-pricing-disclosure">
			  <summary class="volume-pricing-toggle">
				<span>{{ 'product.volume_pricing.note' | t }}</span>
				<i>
				  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<polyline points="6 9 12 15 18 9"></polyline>
				  </svg>
				</i>
			  </summary>
			  <div class="volume-pricing-table">
				<ul class="volume-pricing-list">
				  <li class="volume-pricing-item">
					<span class="volume-pricing-qty">{{ variant.quantity_rule.min }}+</span>
					<span class="volume-pricing-price">{{ variant.price | money }}</span>
				  </li>
				  {%- for price_break in variant.quantity_price_breaks -%}
					<li class="volume-pricing-item">
					  <span class="volume-pricing-qty">{{ price_break.minimum_quantity }}+</span>
					  <span class="volume-pricing-price">{{ price_break.price | money }}</span>
					</li>
				  {%- endfor -%}
				</ul>
			  </div>
			</details>
		  </div>
		{%- endif -%}

		{%- comment -%} Quantity Rules (min/max/increment) {%- endcomment -%}
		{%- assign quantity_rule = variant.quantity_rule -%}
		{%- if quantity_rule.increment > 1 or quantity_rule.min > 1 or quantity_rule.max != null -%}
		  <div class="product-card__quantity-rules">
			{%- if quantity_rule.increment > 1 -%}
			  <span class="quantity-rule">{{ 'product.quantity.multiples_of' | t: quantity: quantity_rule.increment }}</span>
			{%- endif -%}
			{%- if quantity_rule.min > 1 -%}
			  <span class="quantity-rule">{{ 'product.quantity.min_of' | t: quantity: quantity_rule.min }}</span>
			{%- endif -%}
			{%- if quantity_rule.max != null -%}
			  <span class="quantity-rule">{{ 'product.quantity.max_of' | t: quantity: quantity_rule.max }}</span>
			{%- endif -%}
		  </div>
		{%- endif -%}
	  {%- endif -%}
	  
	  {%- if show_stock -%}
		<div class="product-card__stock">
		{%- render 'html-product-stock',
		  product: p,
		  show_stock_count: false
		-%}
		</div>
	  {%- endif -%}
	  
	  {%- if show_delivery -%}
	  	<div class="product-card__delivery">
	  	{%- render 'html-product-delivery',
			product: p
		 -%}
		</div>
	  {%- endif -%}

	  {%- if show_badges -%}
		<div class="product-card__badges">
		  {%- if p.available == false -%}
			<span class="badge badge--soldout">{{ 'product.sold_out' | t }}</span>
		  {%- elsif p.compare_at_price > p.price -%}
			<span class="badge badge--sale">{{ 'product.on_sale' | t }}</span>
		  {%- endif -%}
		</div>
	  {%- endif -%}

	  {%- if quick_add -%}
	  	<div class="product-card__form">
			{% render 'html-button-order',
			product: p,
			variant_behavior: quick_add_behavior,
			show_icon: true,
			button_style: 'primary'
			%}
		  </div>
	  {%- endif -%}
	</div>
  </div>
{%- endif -%}

<style>
  /* Secondary image hover - only when secondary image exists */
  .product-card__media {
    position: relative;
    overflow: hidden;
    aspect-ratio: var(--card-image-ratio, auto);
  }

  .product-card__media picture {
    display: block;
    width: 100%;
    height: 100%;
  }

  .product-card__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 300ms ease;
  }

  .product-card__img--secondary {
    position: absolute;
    inset: 0;
    opacity: 0;
  }

  .product-card--has-secondary:hover .product-card__img--secondary {
    opacity: 1;
  }

  .product-card--has-secondary:hover .product-card__img:not(.product-card__img--secondary) {
    opacity: 0;
  }

  /* Volume pricing */
  .product-card__volume-pricing {
	margin-top: 0.5em;
  }
  .volume-pricing-disclosure {
	font-size: 0.8em;
  }
  .volume-pricing-toggle {
	display: inline-flex;
	align-items: center;
	gap: 0.25em;
	cursor: pointer;
	color: var(--theme-color-blue, #0f1f38);
	list-style: none;
  }
  .volume-pricing-toggle::-webkit-details-marker {
	display: none;
  }
  .volume-pricing-toggle i {
	width: 1em;
	height: 1em;
	transition: transform 150ms ease;
  }
  .volume-pricing-toggle i svg {
	width: 100%;
	height: 100%;
  }
  details[open] .volume-pricing-toggle i {
	transform: rotate(180deg);
  }
  .volume-pricing-table {
	margin-top: 0.5em;
	padding: 0.5em;
	background-color: var(--theme-color-grey, #f8f8f8);
  }
  .volume-pricing-list {
	list-style: none;
	margin: 0;
	padding: 0;
  }
  .volume-pricing-item {
	display: flex;
	justify-content: space-between;
	padding: 0.25em 0;
	border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  .volume-pricing-item:last-child {
	border-bottom: none;
  }
  .volume-pricing-qty {
	font-weight: 500;
  }
  .product-card__quantity-rules {
	display: flex;
	flex-wrap: wrap;
	gap: 0.5em;
	margin-top: 0.25em;
  }
  .quantity-rule {
	font-size: 0.75em;
	padding: 0.2em 0.5em;
	background-color: var(--theme-color-grey, #f8f8f8);
	border-radius: 2px;
  }

  /* Stock & Delivery in card context */
  .product-card__stock,
  .product-card__delivery {
    margin-top: 0.5em;
    font-size: 0.8em;
  }

  .product-card__stock .product-stock__tag {
    padding: 0.4em 0.8em;
  }
  
  /* Special tweak for client */
  .product-card__stock .product-stock--low-in-stock {
  	color: #009922;
  }

  /* Horizontal layout */
  .product-card--horizontal {
    display: grid;
    grid-template-columns: 40% 1fr;
    gap: 1em;
    align-items: stretch;
  }

  .product-card--horizontal .product-card__media {
    aspect-ratio: var(--card-image-ratio, auto);
  }

  /* When image should fill height (horizontal + adapt) */
  .product-card--horizontal.product-card--image-fill .product-card__media {
    aspect-ratio: unset;
    height: 100%;
  }

  .product-card--horizontal .product-card__content {
    padding: 1em 0;
    display: flex;
    flex-direction: column;
  }

  .product-card--horizontal .product-card__form {
    margin-top: auto;
  }

  .product-card--horizontal .product-card__title {
    font-size: 1em;
  }
</style>
