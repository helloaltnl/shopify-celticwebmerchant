{%- comment -%}
  Product Card
  Accepts:
  - product: {Object} (required)
  - show_secondary_image: {Boolean} (default false)
  - show_vendor: {Boolean} (default false)
  - show_price: {Boolean} (default false)
  - show_price_from: {String} auto | first | first_available | cheapest_available
  - show_stock: {Boolean} (default false)
  - show_stock_from: {String} auto | first | first_available | cheapest_available (fallback: show_price_from)
  - show_delivery: {Boolean} (default false, requires metafields.ism_deliverydate.deliverydate )
  - show_rating: {Boolean} (default false, requires metafields.reviews)
  - show_badges: {Boolean} (default true)
  - quick_add: {Boolean} (default false)
{%- endcomment -%}

{%- assign p = product | default: card_product -%}
{%- if p and p != empty -%}
  <div class="product-card">
	<!-- Media -->
	<figure class="product-card__media">
		<a href="{{ p.url }}"> </a>
		<picture>
		{%- if p.featured_media -%}
		  {%- assign img = p.featured_media -%}
		  {%- assign img_alt = p.featured_media.alt | default: p.title | escape -%}
		  <img
			class="product-card__img lazy"
			alt="{{ img_alt | escape }}"
			width="{{ img.width }}"
			height="{{ img.height }}"
			data-src="{{ img | image_url: width: 640 }}"
			data-srcset="
			  {{ img | image_url: width: 320  }} 320w,
			  {{ img | image_url: width: 480  }} 480w,
			  {{ img | image_url: width: 640  }} 640w,
			  {{ img | image_url: width: 800  }} 800w,
			  {{ img | image_url: width: 960  }} 960w,
			  {{ img | image_url: width: 1200 }} 1200w"
			data-sizes="(min-width: 990px) 25vw, (min-width: 750px) 33vw, 50vw"
		  />
		  {%- if show_secondary_image and p.media[1] -%}
			{%- assign alt_second = p.media[1].alt | default: p.title | escape -%}
			{{ p.media[1]
			  | image_url: width: 800
			  | image_tag:
				alt: alt_second,
				loading: 'lazy',
				class: 'product-card__img product-card__img--secondary'
			}}
		  {%- endif -%}
		{%- else -%}
		  <div class="product-card__placeholder" aria-hidden="true"></div>
		{%- endif -%}
	   
		</picture>
	</figure>
	<!-- Content -->
	<div class="product-card__content">
	  <h3 class="product-card__title">
		<a href="{{ p.url }}">{{ p.title | escape }}</a>
	  </h3>

	  {%- if show_vendor -%}
		<div class="product-card__vendor">{{ p.vendor }}</div>
	  {%- endif -%}

	  {%- if show_rating and p.metafields.reviews.rating.value != blank -%}
		{%- assign rating = p.metafields.reviews.rating.value -%}
		<div class="product-card__rating">
		  ⭐ {{ rating.rating }} / {{ rating.scale_max }} ({{ rating.rating_count }})
		</div>
	  {%- endif -%}

	  {%- if show_price -%}
		{%- render 'html-product-price',
		  product: p,
		  show: show_price,
		  from: show_price_from,
		  show_compare: true
		-%}
	  {%- endif -%}
	  
	  {%- if show_stock -%}
		{%- render 'html-product-stock',
		  product: p,
		  show: show_stock,
		  from: show_stock_from | default: show_price_from,
		  show_low_stock: true,
		  low_stock_threshold: 2
		-%}
	  {%- endif -%}

	  {%- if show_badges -%}
		<div class="product-card__badges">
		  {%- if p.available == false -%}
			<span class="badge badge--soldout">{{ 'products.product.sold_out' | t }}</span>
		  {%- elsif p.compare_at_price > p.price -%}
			<span class="badge badge--sale">{{ 'products.product.on_sale' | t }}</span>
		  {%- endif -%}
		</div>
	  {%- endif -%}
	  
	  {%- if show_delivery -%}
	  	{%- render 'html-product-delivery',
			product: p
		 -%}
	  {%- endif -%}

	  {%- if quick_add -%}
		{%- assign unique_id = p.id | append: '-' | append: 'now' | date: '%s%N' -%}
		<form method="post" action="/cart/add" class="product-card__form" data-product-card-form="{{ unique_id }}">
		  <input type="hidden" name="id" value="{{ p.selected_or_first_available_variant.id }}">
		  <button type="submit" class="is-button btn btn--add" data-add-button {% unless p.available %}disabled{% endunless %}>
			  <i><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 29.04 25" style="enable-background:new 0 0 29.04 25;" xml:space="preserve" fill="currentColor"><path d="M11.04,23c0,1.1-0.9,2-2,2s-2-0.9-2-2s0.9-2,2-2S11.04,21.9,11.04,23z M20.04,21c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2
				S21.14,21,20.04,21z M29.04,7c0,3.57-2.67,6.5-6.11,6.94l-0.5,2.64c-0.29,1.43-1.56,2.42-3,2.42h-9.7c-0.02,0-0.04,0-0.06,0
				c-1.41,0-2.64-1.01-2.92-2.42L5.06,8.24C5.06,8.21,5.05,8.18,5.05,8.15L4.22,4H1.04c-0.55,0-1-0.45-1-1s0.45-1,1-1h4
				c0.48,0,0.89,0.34,0.98,0.8L6.86,7h8.18c0-3.87,3.13-7,7-7C25.9,0,29.04,3.13,29.04,7z M20.89,13.9c-2.66-0.44-4.81-2.36-5.56-4.9
				H7.26l1.44,7.19c0.09,0.48,0.48,0.79,1,0.81h9.74c0.5-0.01,0.92-0.33,1.02-0.8L20.89,13.9z M25.54,6.5h-3v-3h-1v3h-3v1h3v3h1v-3h3
				V6.5z"></path></svg></i>
			<span data-button-text>
			  {%- if p.available -%}
				{{ 'products.product.add_to_cart' | t }}
			  {%- else -%}
				{{ 'products.product.sold_out' | t }}
			  {%- endif -%}
			</span>
			<span data-button-loader style="display:none;">Toevoegen...</span>
		  </button>
		</form>
		
		<script>
		  (function() {
			const form = document.querySelector('[data-product-card-form="{{ unique_id }}"]');
			if (!form) return;
			
			form.addEventListener('submit', async function(e) {
			  e.preventDefault();
			  
			  const button = this.querySelector('[data-add-button]');
			  const buttonText = button.querySelector('[data-button-text]');
			  const buttonLoader = button.querySelector('[data-button-loader]');
			  const variantId = this.querySelector('input[name="id"]').value;
			  
			  // Update button state
			  button.disabled = true;
			  buttonText.style.display = 'none';
			  buttonLoader.style.display = 'inline';
			  
			  try {
				const response = await fetch('/cart/add.js', {
				  method: 'POST',
				  headers: {
					'Content-Type': 'application/json',
				  },
				  body: JSON.stringify({
					items: [{
					  id: variantId,
					  quantity: 1
					}]
				  })
				});
				
				if (!response.ok) {
				  throw new Error('Network response was not ok');
				}
				
				const data = await response.json();
				
				// Success feedback
				buttonText.textContent = '✓ Toegevoegd';
				buttonText.style.display = 'inline';
				buttonLoader.style.display = 'none';
				
				// Trigger cart update event for other components
				document.documentElement.dispatchEvent(new CustomEvent('cart:updated', {
				  detail: data
				}));
				
				// If on cart page, trigger dynamic cart update
				if (window.location.pathname.includes('/cart')) {
				  const cartItems = document.querySelector('cart-items');
				  if (cartItems && typeof cartItems.onCartUpdate === 'function') {
					// Use existing cart update mechanism
					cartItems.onCartUpdate();
				  }
				  
				  // Update recommended products section if it exists
				  const recommendedSection = document.querySelector('.block-product-recommended');
				  if (recommendedSection) {
					setTimeout(() => {
					  fetch(window.location.pathname + '?section_id=block-product-recommended')
						.then(response => response.text())
						.then(html => {
						  const parser = new DOMParser();
						  const doc = parser.parseFromString(html, 'text/html');
						  const newSection = doc.querySelector('.block-product-recommended');
						  if (newSection) {
							recommendedSection.innerHTML = newSection.innerHTML;
						  }
						})
						.catch(err => console.error('Error updating recommendations:', err));
					}, 300);
				  }
				} else {
				  // Reset button after 2 seconds on other pages
				  setTimeout(() => {
					buttonText.textContent = '{{ 'products.product.add_to_cart' | t }}';
					button.disabled = false;
				  }, 2000);
				}
				
			  } catch (error) {
				console.error('Error adding to cart:', error);
				
				// Error feedback
				buttonText.textContent = '✗ Probeer opnieuw';
				buttonText.style.display = 'inline';
				buttonLoader.style.display = 'none';
				button.disabled = false;
			  }
			});
		  })();
		</script>
	  {%- endif -%}
	</div>
  </div>
{%- endif -%}
