{% comment %}
  Renders cart subtotal with discounts and tax information
  
  Accepts:
  - cart: {Object} Cart object (required)
  - show_cart_note: {Boolean} Show cart note textarea - default: false
  - context: {String} Context ('page' | 'drawer' | 'preview') - default: 'page'
  
  Usage:
  {% render 'html-cart-subtotal', cart: cart, show_cart_note: true %}
{% endcomment %}

{%- liquid
  assign show_cart_note = show_cart_note | default: false
  assign context = context | default: 'page'
-%}

<style>
  .cart-subtotal {
    padding: 1.5rem 0;
  }

  .cart-subtotal__discounts {
    margin: 0 0 1rem;
    padding: 0;
    list-style: none;
  }

  .cart-subtotal__discount {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0;
    font-size: 0.875rem;
    color: rgb(var(--color-sale));
  }

  .cart-subtotal__discount svg {
    width: 1rem;
    height: 1rem;
  }

  .cart-subtotal__totals {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 1rem 0;
    border-top: 1px solid rgba(var(--color-foreground), 0.08);
  }

  .cart-subtotal__label {
    font-size: 1.125rem;
    font-weight: 500;
  }

  .cart-subtotal__value {
    font-size: 1.5rem;
    font-weight: 600;
  }

  .cart-subtotal__tax-note {
    margin: 1rem 0 0;
    font-size: 0.875rem;
    color: rgba(var(--color-foreground), 0.75);
    line-height: 1.5;
  }

  .cart-subtotal__tax-note a {
    color: rgb(var(--color-link));
    text-decoration: underline;
  }

  .cart-note {
    margin-top: 1.5rem;
  }

  .cart-note__label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .cart-note__textarea {
    width: 100%;
    min-height: 80px;
    padding: 0.75rem;
    font-size: 0.875rem;
    font-family: inherit;
    line-height: 1.5;
    border: 1px solid rgba(var(--color-foreground), 0.2);
    border-radius: var(--border-radius);
    resize: vertical;
  }

  .cart-note__textarea:focus {
    outline: none;
    border-color: rgb(var(--color-foreground));
  }

  /* Compact mode for drawer */
  {% if context == 'drawer' or context == 'preview' %}
  .cart-subtotal {
    padding: 1rem 0;
  }

  .cart-subtotal__label {
    font-size: 1rem;
  }

  .cart-subtotal__value {
    font-size: 1.25rem;
  }
  {% endif %}
</style>

<div class="cart-subtotal">
  {%- comment -%} Cart-level Discounts {%- endcomment -%}
  {%- if cart.cart_level_discount_applications.size > 0 -%}
    <ul class="cart-subtotal__discounts">
      {%- for discount in cart.cart_level_discount_applications -%}
        <li class="cart-subtotal__discount">
          {{- 'icon-discount.svg' | inline_asset_content -}}
          <span>
            {{ discount.title | escape }}
            (-{{ discount.total_allocated_amount | money }})
          </span>
        </li>
      {%- endfor -%}
    </ul>
  {%- endif -%}

  {%- comment -%} Estimated Total {%- endcomment -%}
  <div class="cart-subtotal__totals">
    <h2 class="cart-subtotal__label">
      {{ 'sections.cart.estimated_total' | t }}
    </h2>
    <p class="cart-subtotal__value">
      {{ cart.total_price | money_with_currency }}
    </p>
  </div>

  {%- comment -%} Tax & Shipping Information {%- endcomment -%}
  <div class="cart-subtotal__tax-note">
    {%- if cart.duties_included and cart.taxes_included -%}
      {%- if shop.shipping_policy.body == blank -%}
        {{ 'sections.cart.duties_and_taxes_included_shipping_at_checkout_without_policy' | t }}
      {%- else -%}
        {{
          'sections.cart.duties_and_taxes_included_shipping_at_checkout_with_policy_html'
          | t: link: shop.shipping_policy.url
        }}
      {%- endif -%}
    {%- elsif cart.duties_included == false and cart.taxes_included -%}
      {%- if shop.shipping_policy.body == blank -%}
        {{ 'sections.cart.taxes_included_shipping_at_checkout_without_policy' | t }}
      {%- else -%}
        {{
          'sections.cart.taxes_included_shipping_at_checkout_with_policy_html'
          | t: link: shop.shipping_policy.url
        }}
      {%- endif -%}
    {%- elsif cart.duties_included and cart.taxes_included == false -%}
      {%- if shop.shipping_policy.body == blank -%}
        {{ 'sections.cart.duties_included_taxes_at_checkout_shipping_at_checkout_without_policy' | t }}
      {%- else -%}
        {{
          'sections.cart.duties_included_taxes_at_checkout_shipping_at_checkout_with_policy_html'
          | t: link: shop.shipping_policy.url
        }}
      {%- endif -%}
    {%- elsif cart.duties_included == false and cart.taxes_included == false -%}
      {%- if shop.shipping_policy.body == blank -%}
        {{ 'sections.cart.taxes_at_checkout_shipping_at_checkout_without_policy' | t }}
      {%- else -%}
        {{
          'sections.cart.taxes_at_checkout_shipping_at_checkout_with_policy_html'
          | t: link: shop.shipping_policy.url
        }}
      {%- endif -%}
    {%- endif -%}
  </div>

  {%- comment -%} Cart Note (Optional) {%- endcomment -%}
  {%- if show_cart_note -%}
    <cart-note class="cart-note">
      <label for="CartNote-{{ context }}" class="cart-note__label">
        {{ 'sections.cart.note' | t }}
      </label>
      <textarea
        id="CartNote-{{ context }}"
        class="cart-note__textarea"
        name="note"
        placeholder="{{ 'sections.cart.note' | t }}"
      >{{ cart.note }}</textarea>
    </cart-note>
  {%- endif -%}
</div>
