{%- comment -%}
============================================================================
HTML-ARTICLES-GRID
============================================================================
Shared article grid logic for blog overview sections.
Collects articles from multiple blogs and sorts by date.

PARAMETERS:
- blocks: {Array} Section blocks containing blog selections
- articles_per_blog: {Number} Max articles per blog (default: 5)
- max_articles: {Number} Max total articles (default: 12)
- card_layout: {String} 'vertical' | 'horizontal' (default: 'vertical')
- show_image: {Boolean} Show featured image (default: true)
- show_blog_title: {Boolean} Show blog title on cards (default: true)
- show_date: {Boolean} Show article date (default: true)
- show_excerpt: {Boolean} Show article excerpt (default: true)
- show_cta: {Boolean} Show read more link (default: true)
- image_ratio: {String} 'adapt' | 'square' | 'portrait' | 'landscape' (default: 'landscape')
- class_prefix: {String} CSS class prefix (default: 'articles-grid')

OUTPUT:
Renders <li> elements with html-article-card for each article.
Wrap in a <ul> with appropriate grid styling.
============================================================================
{%- endcomment -%}

{%- liquid
	assign articles_per_blog = articles_per_blog | default: 5
	assign max_articles = max_articles | default: 12
	assign card_layout = card_layout | default: 'vertical'
	assign image_ratio = image_ratio | default: 'landscape'
	assign class_prefix = class_prefix | default: 'articles-grid'
	
	comment
		Color defaults - check for blank to handle empty strings
	endcomment
	if card_background == blank
		assign card_background = '#ffffff'
	endif
	if card_text_color == blank
		assign card_text_color = '#111111'
	endif
	
	comment
		Boolean defaults - check for nil to allow false values
	endcomment
	if show_image == nil
		assign show_image = true
	endif
	if show_blog_title == nil
		assign show_blog_title = true
	endif
	if show_date == nil
		assign show_date = true
	endif
	if show_excerpt == nil
		assign show_excerpt = true
	endif
	if show_cta == nil
		assign show_cta = true
	endif
-%}

{%- comment -%} 
	Collect all articles as sortable strings: timestamp|blog_handle|article_handle
	Sort by timestamp descending to mix articles from different blogs by date
{%- endcomment -%}

{%- assign all_articles = '' -%}

{%- for block in blocks -%}
	{%- if block.type == 'blog' and block.settings.blog != blank -%}
		{%- assign selected_blog = blogs[block.settings.blog] -%}
		{%- for article in selected_blog.articles limit: articles_per_blog -%}
			{%- capture entry -%}{{ article.published_at | date: '%s' }}|{{ block.settings.blog }}|{{ article.handle }}{%- endcapture -%}
			{%- if all_articles == '' -%}
				{%- assign all_articles = entry -%}
			{%- else -%}
				{%- assign all_articles = all_articles | append: ',' | append: entry -%}
			{%- endif -%}
		{%- endfor -%}
	{%- endif -%}
{%- endfor -%}

{%- assign sorted_entries = all_articles | split: ',' | sort | reverse -%}

{%- assign article_count = 0 -%}
{%- for entry in sorted_entries -%}
	{%- if entry != blank and article_count < max_articles -%}
		{%- assign parts = entry | split: '|' -%}
		{%- assign blog_handle = parts[1] -%}
		{%- assign article_handle = parts[2] -%}
		{%- assign current_blog = blogs[blog_handle] -%}
		
		{%- assign current_article = nil -%}
		{%- for article in current_blog.articles -%}
			{%- if article.handle == article_handle -%}
				{%- assign current_article = article -%}
				{%- break -%}
			{%- endif -%}
		{%- endfor -%}
		
		{%- if current_article -%}
			{%- liquid
				assign lazy_load = true
				if article_count < 4
					assign lazy_load = false
				endif
			-%}
			<li class="{{ class_prefix }}__item">
				{%- render 'html-article-card',
					article: current_article,
					blog_title: current_blog.title,
					layout: card_layout,
					show_image: show_image,
					show_blog: show_blog_title,
					show_date: show_date,
					show_excerpt: show_excerpt,
					show_cta: show_cta,
					image_ratio: image_ratio,
					lazy_load: lazy_load,
					card_background: card_background,
					card_text_color: card_text_color
				-%}
			</li>
			{%- assign article_count = article_count | plus: 1 -%}
		{%- endif -%}
	{%- endif -%}
{%- endfor -%}
