{%- comment -%}
============================================================================
BLOCK-MARKETING-BRANDS-SMALL (Curated)
============================================================================
Brand logo grid/slider section with manually selected collections via blocks.

FEATURES:
- Manually select brand collections via blocks
- Display mode: Grid or Slider (Swiper)
- Configurable columns per breakpoint
- Optional brand titles
- Correct responsive image sizing
- Slider options: navigation, pagination, loop, autoplay

ACCESSIBILITY:
- Grid mode: <ul role="list"> with <li> for proper list semantics
- Slider mode: <div> elements (Swiper manipulates DOM)

DEPENDENCIES:
- html-theme-media-image snippet
- html-marketing-cta snippet
- html-theme-icons snippet (for slider navigation)
- Swiper.js (loaded conditionally for slider mode)
============================================================================
{%- endcomment -%}

{%- liquid
	assign has_heading = false
	if section.settings.heading != blank
		assign has_heading = true
	endif
	
	assign has_button = false
	if section.settings.button_url != blank
		assign has_button = true
	endif
	
	assign display_mode = section.settings.display_mode | default: 'grid'
	assign is_slider = false
	if display_mode == 'slider'
		assign is_slider = true
	endif
	
	case section.settings.image_ratio
		when 'square'
			assign ratio = '1 / 1'
		when 'portrait'
			assign ratio = '2 / 3'
		when 'landscape'
			assign ratio = '3 / 2'
		else
			assign ratio = '1 / 1'
	endcase
	
	comment
		Container width in pixels (match theme-ui.scss)
	endcomment
	case section.settings.width
		when 'is-align-narrow'
			assign container_px = 480
		when 'is-align-small'
			assign container_px = 640
		when 'is-align'
			assign container_px = 960
		when 'is-align-wide'
			assign container_px = 1280
		when 'is-align-full'
			assign container_px = 1600
		else
			assign container_px = 1280
	endcase
	
	assign columns_desktop = section.settings.columns_desktop | default: 6
	assign columns_tablet = section.settings.columns_tablet | default: 4
	assign columns_mobile = section.settings.columns_mobile | default: 2
	assign layout_gap_em = section.settings.grid_gap | default: 0.5
	
	comment
		Gap in pixels
	endcomment
	assign gap_px = layout_gap_em | times: 16
	
	comment
		Calculate actual display sizes per breakpoint
	endcomment
	assign desktop_gaps = columns_desktop | minus: 1 | times: gap_px
	assign desktop_available = container_px | minus: desktop_gaps
	assign desktop_image = desktop_available | divided_by: columns_desktop | round
	
	assign tablet_gaps = columns_tablet | minus: 1 | times: gap_px
	assign tablet_available = 960 | minus: tablet_gaps
	assign tablet_image = tablet_available | divided_by: columns_tablet | round
	
	assign mobile_gaps = columns_mobile | minus: 1 | times: gap_px
	assign mobile_available = 480 | minus: mobile_gaps
	assign mobile_image = mobile_available | divided_by: columns_mobile | round
	
	comment
		Build sizes attribute (actual display sizes)
	endcomment
	assign img_sizes = '(min-width: 60em) ' | append: desktop_image | append: 'px, (min-width: 40em) ' | append: tablet_image | append: 'px, ' | append: mobile_image | append: 'px'
	
	comment
		Srcset widths based on desktop (largest display)
		Provides 1x, 1.5x, 2x, 2.5x, 3x for retina
	endcomment
	assign base = desktop_image
	if base < 100
		assign base = 100
	endif
	
	assign w1 = base | round
	assign w2 = base | times: 1.5 | round
	assign w3 = base | times: 2 | round
	assign w4 = base | times: 2.5 | round
	assign w5 = base | times: 3 | round
	if w5 > 2048
		assign w5 = 2048
	endif
	if w4 > 2048
		assign w4 = 2048
	endif
-%}

<div class="block-marketing-brands-small__content {{ section.settings.width }}{% if section.settings.custom_class != blank %} {{ section.settings.custom_class }}{% endif %}"{% if section.settings.anchor != blank %} id="{{ section.settings.anchor }}"{% endif %}>
	{%- if has_heading -%}
		<header class="block-marketing-brands-small__header">
			<h2 class="block-marketing-brands-small__title">{{ section.settings.heading }}</h2>
		</header>
	{%- endif -%}

	{%- if section.blocks.size > 0 -%}
		{%- if is_slider -%}
			{%- comment -%} Slider mode {%- endcomment -%}
			<div class="block-marketing-brands-small__slider swiper{% if has_heading %} block-marketing-brands-small__slider--has-heading{% endif %}" id="swiper-{{ section.id }}" style="--grid-gap: {{ layout_gap_em }}em;">
				<div class="swiper-wrapper">
					{%- for block in section.blocks -%}
						{%- assign collection = block.settings.collection -%}
						
						{%- if collection -%}
							<div class="block-marketing-brands-small__item swiper-slide" {{ block.shopify_attributes }}>
								<a href="{{ collection.url }}" class="block-marketing-brands-small__link">
									{%- assign brand_image = collection.image | default: collection.featured_image -%}
									{%- if brand_image -%}
										<figure class="block-marketing-brands-small__image">
											{%- render 'html-theme-media-image',
											image: brand_image,
											alt: collection.title,
											w1: w1,
											w2: w2,
											w3: w3,
											w4: w4,
											w5: w5,
											sizes: img_sizes,
											image_loading: 'lazy'
											-%}
											</figure>
											{%- endif -%}
											{%- if section.settings.show_titles -%}
											<span class="block-marketing-brands-small__name">{{ collection.title }}</span>
											{%- endif -%}
											</a>
											</div>
											{%- endif -%}
											{%- endfor -%}
											</div>
				{%- if section.settings.slider_navigation -%}
					<button class="swiper-nav swiper-nav--prev swiper-nav--chevron" aria-label="{{ 'accessibility.previous' | t }}">
						{%- render 'html-theme-icons', icon: 'chevron-left' -%}
					</button>
					<button class="swiper-nav swiper-nav--next swiper-nav--chevron" aria-label="{{ 'accessibility.next' | t }}">
						{%- render 'html-theme-icons', icon: 'chevron-right' -%}
					</button>
				{%- endif -%}
				{%- if section.settings.slider_pagination -%}
					<div class="swiper-pagination"></div>
				{%- endif -%}
			</div>
		{%- else -%}
			{%- comment -%} Grid mode {%- endcomment -%}
			<ul class="block-marketing-brands-small__grid{% if has_heading %} block-marketing-brands-small__grid--has-heading{% endif %}" role="list" style="--grid-columns: {{ columns_desktop }}; --grid-columns-tablet: {{ columns_tablet }}; --grid-columns-mobile: {{ columns_mobile }}; --grid-gap: {{ layout_gap_em }}em;">
				{%- for block in section.blocks -%}
					{%- assign collection = block.settings.collection -%}
					
					{%- if collection -%}
						<li class="block-marketing-brands-small__item" {{ block.shopify_attributes }}>
							<a href="{{ collection.url }}" class="block-marketing-brands-small__link">
								{%- assign brand_image = collection.image | default: collection.featured_image -%}
								{%- if brand_image -%}
									<figure class="block-marketing-brands-small__image">
										{%- render 'html-theme-media-image',
										image: brand_image,
										alt: collection.title,
										w1: w1,
										w2: w2,
										w3: w3,
										w4: w4,
										w5: w5,
										sizes: img_sizes,
										image_loading: 'lazy'
										-%}
										</figure>
										{%- endif -%}
										{%- if section.settings.show_titles -%}
										<span class="block-marketing-brands-small__name">{{ collection.title }}</span>
										{%- endif -%}
										</a>
										</li>
										{%- endif -%}
										{%- endfor -%}
</ul>
		{%- endif -%}
	{%- endif -%}

	{%- if has_button -%}
		<div class="block-marketing-brands-small__actions">
			{%- render 'html-marketing-cta',
				text: section.settings.button_text,
				url: section.settings.button_url,
				style: section.settings.button_style,
				button_color: section.settings.button_color,
				button_text_color: section.settings.button_text_color
			-%}
		</div>
	{%- endif -%}
</div>

{% style %}
	#shopify-section-{{ section.id }}.block-marketing-brands-small {
		background-color: {{ section.settings.background_color }};
		color: {{ section.settings.text_color }};
		padding-block: {{ section.settings.padding_block }}em;
	}

	.block-marketing-brands-small__header {
		text-align: center;
	}

	.block-marketing-brands-small__title {
		font-family: var(--theme-font-family-serif);
		font-size: 2em;
		font-weight: 400;
		margin: 0;
	}

	#shopify-section-{{ section.id }} .block-marketing-brands-small__grid {
		display: grid;
		grid-template-columns: repeat(var(--grid-columns-mobile, 2), 1fr);
		gap: var(--grid-gap, 0.5em);
		list-style: none;
		margin: 0;
		padding: 0;
	}

	#shopify-section-{{ section.id }} .block-marketing-brands-small__grid--has-heading,
	#shopify-section-{{ section.id }} .block-marketing-brands-small__slider--has-heading {
		margin-block-start: 2em;
	}

	@media (min-width: 40em) {
		#shopify-section-{{ section.id }} .block-marketing-brands-small__grid {
			grid-template-columns: repeat(var(--grid-columns-tablet, 4), 1fr);
		}
	}

	@media (min-width: 60em) {
		#shopify-section-{{ section.id }} .block-marketing-brands-small__grid {
			grid-template-columns: repeat(var(--grid-columns, 6), 1fr);
		}
	}

	#shopify-section-{{ section.id }} .block-marketing-brands-small__item {
		margin: 0;
	}

	.block-marketing-brands-small__link {
		display: block;
		text-decoration: none;
		color: inherit;
		background-color: {{ section.settings.card_background | default: '#ffffff' }};
		border: 1px solid rgba(0, 0, 0, 0.1);
		overflow: hidden;
		transition: transform 200ms ease, box-shadow 200ms ease;
	}

	.block-marketing-brands-small__link:hover {
		transform: translateY(-4px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
	}

	.block-marketing-brands-small__image {
		width: 100%;
		aspect-ratio: {{ ratio }};
		overflow: hidden;
		background-color: {{ section.settings.card_background | default: '#ffffff' }};
		margin: 0;
		padding: 0.2em;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.block-marketing-brands-small__image .theme-media__img {
		width: 100%;
		height: 100%;
		object-fit: {{ section.settings.image_fit }};
	}

	.block-marketing-brands-small__name {
		display: block;
		padding: 1em;
		text-align: center;
		font-weight: 600;
	}

	.block-marketing-brands-small__actions {
		display: flex;
		justify-content: center;
		margin-block-start: 2em;
	}

	.block-marketing-brands-small__actions .marketing-cta {
		padding: 0;
	}

	/* Slider styles */
	.block-marketing-brands-small__slider {
		position: relative;
		overflow: hidden;
	}

	.block-marketing-brands-small__slider .swiper-wrapper {
		align-items: stretch;
	}

	.block-marketing-brands-small__slider .swiper-slide {
		height: auto;
	}

	/* When all slides fit: center and hide controls */
	.block-marketing-brands-small__slider.swiper--all-visible .swiper-wrapper {
		justify-content: center;
	}

	.block-marketing-brands-small__slider.swiper--all-visible .swiper-nav,
	.block-marketing-brands-small__slider.swiper--all-visible .swiper-pagination {
		display: none;
	}
{% endstyle %}

{%- if is_slider -%}
<script>
	(function() {
		function initBrandsSmallSwiper() {
			const swiperEl = document.getElementById('swiper-{{ section.id }}');
			if (!swiperEl || typeof Swiper === 'undefined') return;
			
			if (swiperEl.swiper) swiperEl.swiper.destroy();

			const fontSize = parseFloat(getComputedStyle(swiperEl).fontSize);
			const gapEm = parseFloat('{{ layout_gap_em }}');
			const gapPx = gapEm * fontSize;

			const config = {
				slidesPerView: {{ columns_mobile }},
				spaceBetween: gapPx,
				{%- if section.settings.slider_navigation -%}
				navigation: {
					prevEl: swiperEl.querySelector('.swiper-nav--prev'),
					nextEl: swiperEl.querySelector('.swiper-nav--next')
				},
				{%- endif -%}
				{%- if section.settings.slider_pagination -%}
				pagination: {
					el: swiperEl.querySelector('.swiper-pagination'),
					clickable: true
				},
				{%- endif -%}
				{%- if section.settings.slider_autoplay -%}
				autoplay: {
					delay: {{ section.settings.slider_autoplay_speed | default: 5 | times: 1000 }},
					disableOnInteraction: false,
					pauseOnMouseEnter: true
				},
				rewind: true,
				{%- endif -%}
				breakpoints: {
					640: {
						slidesPerView: {{ columns_tablet }}
					},
					960: {
						slidesPerView: {{ columns_desktop }}
					}
				},
				on: {
					init: updateSliderState,
					resize: updateSliderState
				}
			};

			function updateSliderState(swiper) {
				const slidesCount = swiper.slides.length;
				const slidesPerView = swiper.params.slidesPerView;
				const allFit = slidesCount <= slidesPerView;
				
				swiperEl.classList.toggle('swiper--all-visible', allFit);
				
				if (allFit) {
					if (swiper.autoplay && swiper.autoplay.running) {
						swiper.autoplay.stop();
					}
				} else {
					swiper.params.slidesPerGroup = Math.floor(slidesPerView);
					{%- if section.settings.slider_autoplay -%}
					if (swiper.autoplay && !swiper.autoplay.running) {
						swiper.autoplay.start();
					}
					{%- endif -%}
					swiper.update();
				}
			}

			new Swiper(swiperEl, config);
		}

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initBrandsSmallSwiper);
		} else {
			initBrandsSmallSwiper();
		}
	})();
</script>
{%- endif -%}

{% schema %}
{
	"name": "Marketing brands curated",
	"tag": "section",
	"class": "block-marketing-brands-small",
	"disabled_on": {
		"groups": ["header", "footer"]
	},
	"settings": [
		{
			"type": "header",
			"content": "Content"
		},
		{
			"type": "text",
			"id": "heading",
			"label": "Heading"
		},
		{
			"type": "text",
			"id": "button_text",
			"label": "Button text",
			"info": "Leave empty to use locale default"
		},
		{
			"type": "url",
			"id": "button_url",
			"label": "Button link"
		},
		{
			"type": "select",
			"id": "button_style",
			"label": "Button style",
			"options": [
				{ "value": "primary", "label": "Primary" },
				{ "value": "secondary", "label": "Secondary" },
				{ "value": "outline", "label": "Outline" }
			],
			"default": "primary"
		},
		{
			"type": "header",
			"content": "Collection card"
		},
		{
			"type": "checkbox",
			"id": "show_titles",
			"label": "Show brand titles",
			"default": true
		},
		{
			"type": "select",
			"id": "image_ratio",
			"label": "Image ratio",
			"options": [
				{ "value": "portrait", "label": "Portrait (2:3)" },
				{ "value": "square", "label": "Square (1:1)" },
				{ "value": "landscape", "label": "Landscape (3:2)" }
			],
			"default": "square"
		},
		{
			"type": "select",
			"id": "image_fit",
			"label": "Image fit",
			"options": [
				{ "value": "cover", "label": "Cover" },
				{ "value": "contain", "label": "Contain" }
			],
			"default": "contain"
		},
		{
			"type": "color",
			"id": "card_background",
			"label": "Card background",
			"default": "#ffffff"
		},
		{
			"type": "header",
			"content": "Layout"
		},
		{
			"type": "select",
			"id": "width",
			"label": "Width",
			"options": [
				{ "value": "is-align-narrow", "label": "Narrow" },
				{ "value": "is-align-small", "label": "Small" },
				{ "value": "is-align", "label": "Regular" },
				{ "value": "is-align-wide", "label": "Wide" },
				{ "value": "is-align-full", "label": "Full" }
			],
			"default": "is-align-wide"
		},
		{
			"type": "range",
			"id": "columns_desktop",
			"label": "Columns (desktop)",
			"min": 2,
			"max": 8,
			"step": 1,
			"default": 6
		},
		{
			"type": "range",
			"id": "columns_tablet",
			"label": "Columns (tablet)",
			"min": 2,
			"max": 6,
			"step": 1,
			"default": 4
		},
		{
			"type": "range",
			"id": "columns_mobile",
			"label": "Columns (mobile)",
			"min": 1,
			"max": 4,
			"step": 1,
			"default": 2
		},
		{
			"type": "range",
			"id": "grid_gap",
			"label": "Grid gap",
			"min": 0,
			"max": 2,
			"step": 0.1,
			"default": 0.5,
			"unit": "em"
		},
		{
			"type": "range",
			"id": "padding_block",
			"label": "Vertical padding",
			"min": 0,
			"max": 6,
			"step": 0.5,
			"default": 3,
			"unit": "em"
		},
		{
			"type": "header",
			"content": "Display"
		},
		{
			"type": "select",
			"id": "display_mode",
			"label": "Display mode",
			"options": [
				{ "value": "grid", "label": "Grid" },
				{ "value": "slider", "label": "Slider" }
			],
			"default": "grid"
		},
		{
			"type": "checkbox",
			"id": "slider_navigation",
			"label": "Show navigation",
			"info": "Slider only",
			"default": true
		},
		{
			"type": "checkbox",
			"id": "slider_pagination",
			"label": "Show pagination",
			"info": "Slider only",
			"default": false
		},
		{
			"type": "checkbox",
			"id": "slider_autoplay",
			"label": "Autoplay",
			"info": "Slider only. Includes rewind.",
			"default": false
		},
		{
			"type": "range",
			"id": "slider_autoplay_speed",
			"label": "Autoplay speed",
			"info": "Slider only",
			"min": 2,
			"max": 10,
			"step": 1,
			"default": 5,
			"unit": "s"
		},
		{
			"type": "header",
			"content": "Colors"
		},
		{
			"type": "color",
			"id": "background_color",
			"label": "Background"
		},
		{
			"type": "color",
			"id": "text_color",
			"label": "Text"
		},
		{
			"type": "color",
			"id": "button_color",
			"label": "Button color"
		},
		{
			"type": "color",
			"id": "button_text_color",
			"label": "Button text color"
		},
		{
			"type": "header",
			"content": "Advanced"
		},
		{
			"type": "text",
			"id": "anchor",
			"label": "Anchor",
			"info": "ID for scroll links (without #)"
		},
		{
			"type": "text",
			"id": "custom_class",
			"label": "Custom class",
			"info": "Add custom CSS class for styling"
		}
	],
	"blocks": [
		{
			"type": "brand",
			"name": "Brand",
			"settings": [
				{
					"type": "collection",
					"id": "collection",
					"label": "Collection"
				}
			]
		}
	],
	"presets": [
		{
			"name": "Brands (curated)",
			"category": "Marketing",
			"blocks": [
				{ "type": "brand" },
				{ "type": "brand" },
				{ "type": "brand" },
				{ "type": "brand" },
				{ "type": "brand" },
				{ "type": "brand" }
			]
		}
	]
}
{% endschema %}
