<div id="shopify-section-{{ section.id }}" class="main-account-addresses {{ section.settings.width }}{% if section.settings.custom_class != blank %} {{ section.settings.custom_class }}{% endif %}" data-account-addresses{% if section.settings.anchor != blank %} id="{{ section.settings.anchor }}"{% endif %}>
  <div class="main-account-addresses__container">
    <header class="main-account-addresses__header">
      <h1 class="main-account-addresses__title">{{ 'customer.addresses.title' | t }}</h1>
      <a href="{{ routes.account_url }}" class="main-account-addresses__back">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg>
        {{ 'customer.account.return' | t }}
      </a>
    </header>

    {%- paginate customer.addresses by 10 -%}
      {%- comment -%} Add New Address {%- endcomment -%}
      <div class="main-account-addresses__add" data-address>
        <button type="button" class="main-account-addresses__add-button" aria-expanded="false" aria-controls="AddAddress">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          {{ 'customer.addresses.add_new' | t }}
        </button>

        <div id="AddAddress" class="main-account-addresses__form-wrapper" hidden>
          <h2 class="main-account-addresses__form-title" id="AddressNewHeading">{{ 'customer.addresses.add_new' | t }}</h2>
          {%- form 'customer_address', customer.new_address, aria-labelledBy: 'AddressNewHeading', class: 'main-account-addresses__form' -%}
            {% render 'html-form-address', form: form, id: 'New' %}
            <div class="main-account-addresses__form-actions">
              <button type="submit" class="main-account-addresses__submit">{{ 'customer.addresses.add' | t }}</button>
              <button type="reset" class="main-account-addresses__cancel">{{ 'customer.addresses.cancel' | t }}</button>
            </div>
          {%- endform -%}
        </div>
      </div>

      {%- comment -%} Address List {%- endcomment -%}
      {%- if customer.addresses.size > 0 -%}
        <ul class="main-account-addresses__list">
          {%- for address in customer.addresses -%}
            <li class="main-account-addresses__item" data-address>
              <div class="main-account-addresses__card">
                {%- if address == customer.default_address -%}
                  <span class="main-account-addresses__default-badge">{{ 'customer.addresses.default' | t }}</span>
                {%- endif -%}

                <address class="main-account-addresses__address">
                  {{ address | format_address }}
                </address>

                <div class="main-account-addresses__card-actions">
                  <button
                    type="button"
                    class="main-account-addresses__edit-button"
                    id="EditFormButton_{{ address.id }}"
                    aria-label="{{ 'customer.addresses.edit_address' | t }} {{ forloop.index }}"
                    aria-controls="EditAddress_{{ address.id }}"
                    aria-expanded="false"
                    data-address-id="{{ address.id }}"
                  >
                    {{ 'customer.addresses.edit' | t }}
                  </button>
                  <button
                    type="button"
                    class="main-account-addresses__delete-button"
                    aria-label="{{ 'customer.addresses.delete' | t }} {{ forloop.index }}"
                    data-target="{{ address.url }}"
                    data-confirm-message="{{ 'customer.addresses.delete_confirm' | t }}"
                  >
                    {{ 'customer.addresses.delete' | t }}
                  </button>
                </div>
              </div>

              <div id="EditAddress_{{ address.id }}" class="main-account-addresses__form-wrapper" hidden>
                <h2 class="main-account-addresses__form-title">{{ 'customer.addresses.edit_address' | t }}</h2>
                {%- form 'customer_address', address, class: 'main-account-addresses__form' -%}
                  {% render 'html-form-address', form: form, id: address.id %}
                  <div class="main-account-addresses__form-actions">
                    <button type="submit" class="main-account-addresses__submit">{{ 'customer.addresses.update' | t }}</button>
                    <button type="reset" class="main-account-addresses__cancel">{{ 'customer.addresses.cancel' | t }}</button>
                  </div>
                {%- endform -%}
              </div>
            </li>
          {%- endfor -%}
        </ul>
      {%- endif -%}

      {%- if paginate.pages > 1 -%}
        <nav class="main-account-addresses__pagination" role="navigation" aria-label="{{ 'pagination.label' | t }}">
          {%- if paginate.previous -%}
            <a href="{{ paginate.previous.url }}" class="main-account-addresses__pagination-arrow" aria-label="{{ 'pagination.previous' | t }}">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg>
            </a>
          {%- endif -%}

          <span class="main-account-addresses__pagination-info">
            {{ 'pagination.page_of' | t: current: paginate.current_page, total: paginate.pages | default: 'Page [current] of [total]' | replace: '[current]', paginate.current_page | replace: '[total]', paginate.pages }}
          </span>

          {%- if paginate.next -%}
            <a href="{{ paginate.next.url }}" class="main-account-addresses__pagination-arrow" aria-label="{{ 'pagination.next' | t }}">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="9 18 15 12 9 6"/></svg>
            </a>
          {%- endif -%}
        </nav>
      {%- endif -%}
    {%- endpaginate -%}
  </div>
</div>

<style>
  #shopify-section-{{ section.id }}.main-account-addresses {
    --account-background: {{ section.settings.background_color | default: '#ffffff' }};
    --account-text: {{ section.settings.text_color | default: '#111111' }};
    --account-border: {{ section.settings.text_color | default: '#111111' | color_modify: 'alpha', 0.2 }};

    background-color: var(--account-background);
    color: var(--account-text);
    padding-block: {{ section.settings.padding_block }}em;
  }

  .main-account-addresses__container {
    max-width: 48rem;
    margin-inline: auto;
    padding-inline: 1.5rem;
  }

  .main-account-addresses__header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--account-border);
  }

  .main-account-addresses__title {
    font-family: var(--theme-font-family-serif, Georgia, serif);
    font-size: 2rem;
    font-weight: 400;
    margin: 0;
  }

  .main-account-addresses__back {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: inherit;
    text-decoration: none;
    font-size: 0.875rem;
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .main-account-addresses__back:hover {
    opacity: 1;
  }

  .main-account-addresses__add {
    margin-bottom: 2rem;
  }

  .main-account-addresses__add-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1.5rem;
    background-color: var(--account-text);
    color: var(--account-background);
    border: none;
    border-radius: 0.25rem;
    font-family: inherit;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .main-account-addresses__add-button:hover {
    opacity: 0.85;
  }

  .main-account-addresses__form-wrapper {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background-color: var(--account-border);
    border-radius: 0.5rem;
  }

  .main-account-addresses__form-wrapper[hidden] {
    display: none;
  }

  .main-account-addresses__form-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 1.5rem;
  }

  .main-account-addresses__form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  @media (max-width: 40em) {
    .main-account-addresses__form {
      grid-template-columns: 1fr;
    }
  }

  .main-account-addresses__form-actions {
    grid-column: 1 / -1;
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
  }

  .main-account-addresses__submit {
    padding: 0.75rem 1.5rem;
    background-color: var(--account-text);
    color: var(--account-background);
    border: none;
    border-radius: 0.25rem;
    font-family: inherit;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .main-account-addresses__submit:hover {
    opacity: 0.85;
  }

  .main-account-addresses__cancel {
    padding: 0.75rem 1.5rem;
    background-color: transparent;
    color: var(--account-text);
    border: 1px solid var(--account-border);
    border-radius: 0.25rem;
    font-family: inherit;
    font-size: 0.875rem;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .main-account-addresses__cancel:hover {
    border-color: var(--account-text);
  }

  .main-account-addresses__list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(18rem, 1fr));
    gap: 1.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .main-account-addresses__item {
    margin: 0;
  }

  .main-account-addresses__card {
    padding: 1.5rem;
    background-color: var(--account-border);
    border-radius: 0.5rem;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .main-account-addresses__default-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    margin-bottom: 0.75rem;
    background-color: var(--account-text);
    color: var(--account-background);
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    width: fit-content;
  }

  .main-account-addresses__address {
    font-style: normal;
    line-height: 1.6;
    font-size: 0.875rem;
    flex-grow: 1;
  }

  .main-account-addresses__card-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--account-background);
  }

  .main-account-addresses__edit-button,
  .main-account-addresses__delete-button {
    padding: 0;
    background: none;
    border: none;
    color: inherit;
    font-family: inherit;
    font-size: 0.875rem;
    text-decoration: underline;
    text-underline-offset: 0.2em;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .main-account-addresses__edit-button:hover,
  .main-account-addresses__delete-button:hover {
    opacity: 1;
  }

  .main-account-addresses__delete-button {
    color: #dc2626;
  }

  .main-account-addresses__pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--account-border);
  }

  .main-account-addresses__pagination-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border: 1px solid var(--account-border);
    border-radius: 0.25rem;
    color: inherit;
    text-decoration: none;
    transition: border-color 0.2s ease;
  }

  .main-account-addresses__pagination-arrow:hover {
    border-color: var(--account-text);
  }

  .main-account-addresses__pagination-info {
    font-size: 0.875rem;
  }
</style>

<script>
  (function() {
    const section = document.querySelector('[data-account-addresses]');
    if (!section) return;

    // Toggle form visibility
    section.querySelectorAll('button[aria-controls]').forEach(button => {
      button.addEventListener('click', () => {
        const targetId = button.getAttribute('aria-controls');
        const target = document.getElementById(targetId);
        const isExpanded = button.getAttribute('aria-expanded') === 'true';

        button.setAttribute('aria-expanded', !isExpanded);
        target.hidden = isExpanded;

        if (!isExpanded) {
          target.querySelector('input')?.focus();
        }
      });
    });

    // Handle form reset (cancel buttons)
    section.querySelectorAll('button[type="reset"]').forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const wrapper = button.closest('.main-account-addresses__form-wrapper');
        const toggleButton = section.querySelector(`[aria-controls="${wrapper.id}"]`);
        
        wrapper.hidden = true;
        if (toggleButton) {
          toggleButton.setAttribute('aria-expanded', 'false');
        }
      });
    });

    // Handle delete buttons
    section.querySelectorAll('[data-target][data-confirm-message]').forEach(button => {
      button.addEventListener('click', () => {
        if (confirm(button.dataset.confirmMessage)) {
          const form = document.createElement('form');
          form.method = 'post';
          form.action = button.dataset.target;
          
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = '_method';
          input.value = 'delete';
          form.appendChild(input);
          
          document.body.appendChild(form);
          form.submit();
        }
      });
    });

    // Country/Province selector
    if (typeof Shopify !== 'undefined' && Shopify.CountryProvinceSelector) {
      section.querySelectorAll('[data-address-country-select]').forEach(select => {
        const formId = select.dataset.formId || 'New';
        new Shopify.CountryProvinceSelector(
          `AddressCountry${formId === 'New' ? 'New' : '_' + formId}`,
          `AddressProvince${formId === 'New' ? 'New' : '_' + formId}`,
          { hideElement: `AddressProvinceContainer${formId === 'New' ? 'New' : '_' + formId}` }
        );
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Account addresses",
  "tag": "section",
  "class": "main-account-addresses-wrapper",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
			"type": "select",
			"id": "width",
			"label": "Width",
			"options": [
				{ "value": "is-align-narrow", "label": "Narrow" },
				{ "value": "is-align-small", "label": "Small" },
				{ "value": "is-align", "label": "Regular" },
				{ "value": "is-align-wide", "label": "Wide" },
				{ "value": "is-align-full", "label": "Full" }
			],
			"default": "is-align"
		},
		{
			"type": "range",
			"id": "padding_block",
			"label": "Vertical padding",
			"min": 0,
			"max": 6,
			"step": 0.5,
			"default": 4,
			"unit": "em"
		},
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text"
    },
    {
      "type": "header",
      "content": "Advanced"
    },
    {
      "type": "text",
      "id": "anchor",
      "label": "Anchor",
      "info": "ID for scroll links (without #)"
    },
    {
      "type": "text",
      "id": "custom_class",
      "label": "Custom class",
      "info": "Add custom CSS class"
    },
    {
      "type": "header",
      "content": "Howto"
    },
    {
      "type": "paragraph",
      "content": "Address management page with add, edit, and delete functionality. Displays on /account/addresses page."
    }
  ]
}
{% endschema %}
