{%- assign menu = linklists[section.settings.menu] -%}
{%- liquid
	assign assist_link_text = section.settings.assist_link_text
	if assist_link_text == blank
		assign assist_link_text = 'general.learn_more' | t
	endif
-%}

{%- if menu.links.size > 0 -%}
<header-bottom class="block-header-bottom__wrapper">
	<nav class="block-header-bottom__nav" aria-label="{{ section.settings.menu | replace: '-', ' ' | capitalize }}">
		<div class="block-header-bottom__menu-wrapper alignwide">
			<ul class="block-header-bottom__menu">
			{%- for link in menu.links -%}
				<li class="block-header-bottom__item{% if link.links.size > 0 %} has-dropdown{% endif %}">
					<a href="{{ link.url }}" {% if link.current %}aria-current="page"{% endif %}>
						<span>{{ link.title }}</span>
					</a>

					{%- if link.links.size > 0 -%}
						{%- liquid
							assign detected_collection = false
							assign detected_assist = false
							if link.url contains '/collections/'
								assign url_parts = link.url | split: '/'
								assign handle = url_parts.last
								assign detected_collection = collections[handle]
							endif
							if detected_collection
								assign detected_assist = detected_collection.metafields.custom['collection-assist-reference']
							endif
						-%}

						<div class="block-header-bottom__dropdown">
							<div class="block-header-bottom__dropdown-inner alignwide{% if detected_assist %} has-assist{% endif %}">
								<section class="block-header-bottom__links">
									<ul>
										{%- for child in link.links -%}
											{%- liquid
												assign link_collection = false
												if child.url contains '/collections/'
													assign url_parts = child.url | split: '/'
													assign handle = url_parts.last
													assign link_collection = collections[handle]
												endif
											-%}

											<li class="{% if child.links.size > 0 %}has-dropdown{% endif %}">
												<a href="{{ child.url }}" class="block-header-bottom__link">
													{%- if link_collection.image -%}
														<img 
															class="block-header-bottom__link-image" 
															src="{{ link_collection.image | image_url: width: 96 }}" 
															alt="{{ link_collection.image.alt | default: link_collection.title | escape }}"
															width="80"
															height="80"
															loading="lazy"
														>
													{%- endif -%}
													<span>{{ child.title }}</span>
													{%- if child.links.size > 0 -%}
														<i class="block-header-bottom__caret">
															{% render 'html-theme-icons', icon: 'caret', size: 16 %}
														</i>
													{%- endif -%}
												</a>

												{%- if child.links.size > 0 -%}
													<div class="block-header-bottom__dropdown block-header-bottom__dropdown--nested">
														<div class="block-header-bottom__dropdown-inner alignwide{% if detected_assist %} has-assist{% endif %}">
															<section class="block-header-bottom__links">
																<ul>
																	<li class="block-header-bottom__navigate block-header-bottom__navigate--top">
																		<a href="{{ link.url }}" class="block-header-bottom__link block-header-bottom__link--back">
																			<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
																			<span>{{ link.title }}</span>
																		</a>
																		<a href="{{ child.url }}" class="block-header-bottom__link block-header-bottom__link--all">
																			<span>{{ child.title }}</span>
																			<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
																		</a>
																	</li>

																	{%- for subchild in child.links -%}
																		{%- liquid
																			assign sublink_collection = false
																			if subchild.url contains '/collections/'
																				assign url_parts = subchild.url | split: '/'
																				assign handle = url_parts.last
																				assign sublink_collection = collections[handle]
																			endif
																		-%}

																		<li>
																			<a href="{{ subchild.url }}" class="block-header-bottom__link">
																				{%- if sublink_collection.image -%}
																					<img 
																						class="block-header-bottom__link-image" 
																						src="{{ sublink_collection.image | image_url: width: 96 }}" 
																						alt="{{ sublink_collection.image.alt | default: sublink_collection.title | escape }}"
																						width="80"
																						height="80"
																						loading="lazy"
																					>
																				{%- endif -%}
																				<span>{{ subchild.title }}</span>
																			</a>
																		</li>
																	{%- endfor -%}

																	<li class="block-header-bottom__navigate block-header-bottom__navigate--bottom">
																		<a href="{{ link.url }}" class="block-header-bottom__link block-header-bottom__link--back">
																			<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
																			<span>{{ link.title }}</span>
																		</a>
																		<a href="{{ child.url }}" class="block-header-bottom__link block-header-bottom__link--all">
																			<span>{{ child.title }}</span>
																			<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
																		</a>
																	</li>
																</ul>
															</section>

															{%- if detected_assist -%}
																{%- assign assist = detected_assist.value -%}
																<section class="block-header-bottom__assist">
																	<article class="block-header-bottom__assist-item">
																		{%- if assist.link -%}
																			<a href="{{ assist.link }}" class="block-header-bottom__assist-overlay"></a>
																		{%- endif -%}
																		{%- if assist.image -%}
																			<figure class="block-header-bottom__assist-image">
																				<img src="{{ assist.image | image_url: width: 496 }}" alt="{{ assist.title | escape }}">
																			</figure>
																		{%- endif -%}
																		<section class="block-header-bottom__assist-content">
																			<h3>{{ assist.title }}</h3>
																			{%- if assist.link -%}
																				<span class="block-header-bottom__assist-link">
																					<span>{{ assist_link_text }}</span>
																					<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
																				</span>
																			{%- endif -%}
																		</section>
																	</article>
																</section>
															{%- endif -%}
														</div>
													</div>
												{%- endif -%}
											</li>
										{%- endfor -%}

										<li class="block-header-bottom__navigate block-header-bottom__navigate--bottom">
											<a href="{{ link.url }}" class="block-header-bottom__link block-header-bottom__link--all">
												<span>{{ link.title }}</span>
												<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
											</a>
										</li>
									</ul>
								</section>

								{%- if detected_assist -%}
									{%- assign assist = detected_assist.value -%}
									<section class="block-header-bottom__assist">
										<article class="block-header-bottom__assist-item">
											{%- if assist.link -%}
												<a href="{{ assist.link }}" class="block-header-bottom__assist-overlay"></a>
											{%- endif -%}
											{%- if assist.image -%}
												<figure class="block-header-bottom__assist-image">
													<img src="{{ assist.image | image_url: width: 496 }}" alt="{{ assist.title | escape }}">
												</figure>
											{%- endif -%}
											<section class="block-header-bottom__assist-content">
												<h3>{{ assist.title }}</h3>
												{%- if assist.link -%}
													<span class="block-header-bottom__assist-link">
														<span>{{ assist_link_text }}</span>
														<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
													</span>
												{%- endif -%}
											</section>
										</article>
									</section>
								{%- endif -%}
							</div>
						</div>
					{%- endif -%}
				</li>
			{%- endfor -%}
			</ul>
		</div>
	</nav>
</header-bottom>
{%- endif -%}

{% style %}
	.block-header-bottom {
		background-color: {{ section.settings.background_color }};
		color: {{ section.settings.text_color }};
		position: relative;
		z-index: var(--theme-z-sticky);
	}

	.block-header-bottom__wrapper {
		display: block;
	}

	.block-header-bottom__nav {
		position: relative;
	}

	.block-header-bottom__menu {
		display: flex;
		flex-direction: row;
		flex-wrap: nowrap;
		justify-content: space-between;
		align-items: center;
		gap: 0.5em;
		list-style: none;
		margin: 0;
		padding: 0;
	}

	.block-header-bottom__item {
		position: static;
	}

	.block-header-bottom__item > a {
		display: inline-flex;
		align-items: center;
		height: var(--header-bottom-height, 3.5em);
		padding: 0;
		color: inherit;
		text-decoration: none;
		font-weight: 500;
		position: relative;
	}

	.block-header-bottom__item > a span {
		font-size: 0.9em;
		white-space: nowrap;
		letter-spacing: -0.02em;
	}

	.block-header-bottom__item > a:hover {
		opacity: 0.8;
	}

	.block-header-bottom__item.has-dropdown > a::after {
		content: '';
		position: absolute;
		left: 50%;
		bottom: 0.25em;
		transform: translateX(-50%);
		width: 1em;
		height: 1em;
		opacity: 0.4;
		background-color: currentColor;
		mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>');
		mask-repeat: no-repeat;
		mask-position: center;
		mask-size: 100%;
		-webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>');
		-webkit-mask-repeat: no-repeat;
		-webkit-mask-position: center;
		-webkit-mask-size: 100%;
	}

	.block-header-bottom__dropdown {
		position: absolute;
		left: 0;
		right: 0;
		top: 100%;
		width: 100%;
		background-color: var(--theme-color-grey);
		opacity: 0;
		visibility: hidden;
		transform: translateY(-0.5em);
		transition: opacity 150ms ease, transform 150ms ease, visibility 150ms ease;
		pointer-events: none;
	}

	.block-header-bottom__item.has-dropdown:hover > .block-header-bottom__dropdown,
	.block-header-bottom__item.has-dropdown:focus-within > .block-header-bottom__dropdown {
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
		pointer-events: auto;
	}

	.block-header-bottom__dropdown-inner {
		display: flex;
		flex-direction: row;
		flex-wrap: nowrap;
		gap: 1.5em;
		padding-block: 2em;
	}

	.block-header-bottom__dropdown--nested {
		position: absolute;
		left: 0;
		right: 0;
		top: 0;
		min-height: 100%;
		z-index: 3;
		transform: none;
	}

	.block-header-bottom__links > ul > li.has-dropdown.is-selected > .block-header-bottom__dropdown--nested {
		opacity: 1;
		visibility: visible;
		pointer-events: auto;
	}

	.block-header-bottom__links {
		flex: 1 1 auto;
	}

	.block-header-bottom__links > ul {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(256px, 1fr));
		gap: 0.5em;
		list-style: none;
		margin: 0;
		padding: 0;
	}

	.block-header-bottom__links > ul > li {
		position: static;
		background-color: var(--theme-color-white);
	}

	.block-header-bottom__link {
		position: relative;
		display: flex;
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		gap: 0.75em;
		width: 100%;
		height: 100%;
		min-height: 72px;
		padding: 0.75em;
		overflow: hidden;
		color: inherit;
		text-decoration: none;
		transition: background-color 150ms ease, color 150ms ease;
	}

	.block-header-bottom__link:hover {
		background-color: var(--theme-color-blue);
		color: var(--theme-color-white);
	}

	.block-header-bottom__link-image {
		position: absolute;
		left: 0;
		top: 0;
		bottom: 0;
		width: 72px;
		height: 100%;
		object-fit: cover;
	}

	.block-header-bottom__link-image + span {
		padding-inline-start: 72px;
	}

	.block-header-bottom__link span {
		font-size: 0.85em;
		line-height: 1.3;
	}

	.block-header-bottom__caret {
		flex: 0 0 1em;
		line-height: 1;
	}

	.block-header-bottom__caret svg {
		transform: rotate(-90deg);
	}

	.block-header-bottom__navigate {
		grid-column: 1 / -1;
		text-align: center;
		background-color: transparent !important;
		display: flex;
		justify-content: center;
		gap: 0.5em;
	}

	.block-header-bottom__navigate--top {
		display: none;
	}

	.block-header-bottom__navigate .block-header-bottom__link {
		width: auto;
		height: auto;
		min-height: auto;
		display: inline-flex;
	}

	.block-header-bottom__link--back {
		background-color: var(--theme-color-white);
		color: var(--theme-color-blue);
	}

	.block-header-bottom__link--back span { order: 1; }
	.block-header-bottom__link--back i { order: 0; }
	.block-header-bottom__link--back i svg { transform: rotate(180deg); }

	.block-header-bottom__link--all {
		background-color: var(--theme-color-blue);
		color: var(--theme-color-white);
	}

	.block-header-bottom__assist {
		flex: 0 0 260px;
	}

	.block-header-bottom__assist-item {
		position: relative;
		width: 100%;
		height: 320px;
		overflow: hidden;
		display: flex;
		flex-direction: column;
		justify-content: flex-end;
		background-color: var(--theme-color-blue);
	}

	.block-header-bottom__assist-overlay {
		position: absolute;
		inset: 0;
		z-index: 2;
	}

	.block-header-bottom__assist-image {
		position: absolute;
		inset: 0;
		z-index: 0;
		margin: 0;
		padding: 0;
	}

	.block-header-bottom__assist-image img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		opacity: 0.8;
		transition: opacity 150ms ease, transform 150ms ease;
	}

	.block-header-bottom__assist-item:hover .block-header-bottom__assist-image img {
		opacity: 1;
		transform: scale(1.02);
	}

	.block-header-bottom__assist-content {
		position: relative;
		z-index: 1;
		padding: 1em;
		background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.6) 100%);
	}

	.block-header-bottom__assist-content h3 {
		font-family: var(--theme-font-family-serif);
		font-size: 1.25em;
		font-weight: 700;
		color: #fff;
		margin: 0 0 0.5em 0;
	}

	.block-header-bottom__assist-link {
		display: inline-flex;
		align-items: center;
		gap: 0.4em;
		padding: 0.4em 0.75em;
		background-color: var(--theme-color-blue);
		color: #fff;
		text-decoration: none;
		font-size: 0.9em;
		transition: background-color 150ms ease, color 150ms ease;
	}

	.block-header-bottom__assist-link:hover {
		background-color: #fff;
		color: var(--theme-color-blue);
	}

	.block-header-bottom__assist-link i {
		width: 1em;
		height: 1em;
		line-height: 1;
	}

	.block-header-bottom__nav::after {
		content: '';
		position: absolute;
		z-index: -1;
		top: 100%;
		left: 0;
		right: 0;
		height: 100vh;
		background-color: rgba(0, 0, 0, 0.6);
		opacity: 0;
		visibility: hidden;
		transition: opacity 150ms ease, visibility 150ms ease;
		pointer-events: none;
	}

	.block-header-bottom__item.has-dropdown:hover ~ .block-header-bottom__nav::after,
	.block-header-bottom__nav:has(.has-dropdown:hover)::after {
		opacity: 1;
		visibility: visible;
	}

	@media (max-width: 1024px) {
		.block-header-bottom__nav {
			display: none;
		}
	}
{% endstyle %}

{% javascript %}
	class HeaderBottom extends HTMLElement {
		constructor() {
			super();
		}

		connectedCallback() {
			this.nav = this.querySelector('.block-header-bottom__nav');
			if (this.nav) {
				this.initDesktopNav();
			}
		}

		initDesktopNav() {
			const allItems = [...this.nav.querySelectorAll('li')];

			const getAncestors = (li, boundary) => {
				const ancestors = [];
				let parent = li.parentElement;
				while (parent && parent !== boundary) {
					if (parent.tagName.toLowerCase() === 'li') {
						ancestors.push(parent);
					}
					parent = parent.parentElement;
				}
				return ancestors;
			};

			this.nav.addEventListener('mouseleave', () => {
				allItems.forEach(item => item.classList.remove('is-selected'));
			});

			this.nav.addEventListener('click', (event) => {
				const link = event.target.closest('.has-dropdown > .block-header-bottom__link');
				if (link) {
					const listItem = link.closest('li');
					if (listItem.closest('.block-header-bottom__dropdown')) {
						event.preventDefault();
						const ancestors = getAncestors(listItem, this.nav);
						allItems.forEach(item => {
							if (ancestors.includes(item)) {
								item.classList.add('is-selected');
							} else if (item === listItem) {
								item.classList.toggle('is-selected');
							} else {
								item.classList.remove('is-selected');
							}
						});
					}
				}

				if (event.target.closest('.block-header-bottom__link--back')) {
					event.preventDefault();
					const listItem = event.target.closest('li');
					const ancestors = getAncestors(listItem, this.nav);
					if (ancestors.length > 0) {
						ancestors[0].classList.remove('is-selected');
					}
				}
			});
		}

		disconnectedCallback() {}
	}

	customElements.define('header-bottom', HeaderBottom);
{% endjavascript %}

{% schema %}
{
	"name": "Header bottom",
	"tag": "section",
	"class": "block-header-bottom",
	"limit": 1,
	"enabled_on": {
		"groups": ["header"]
	},
	"settings": [
		{
			"type": "header",
			"content": "Content"
		},
		{
			"type": "link_list",
			"id": "menu",
			"label": "Menu"
		},
		{
			"type": "text",
			"id": "assist_link_text",
			"label": "Assist link text",
			"info": "Leave empty to use locale default"
		},
		{
			"type": "header",
			"content": "Colors"
		},
		{
			"type": "color",
			"id": "background_color",
			"label": "Background",
			"default": "#ffffff"
		},
		{
			"type": "color",
			"id": "text_color",
			"label": "Text",
			"default": "#2e130d"
		}
	],
	"presets": [
		{
			"name": "Navigation",
			"category": "Header"
		}
	]
}
{% endschema %}
