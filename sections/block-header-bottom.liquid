{%- assign menu = linklists[section.settings.menu] -%}
{%- liquid
	assign assist_link_text = section.settings.assist_link_text
	if assist_link_text == blank
		assign assist_link_text = 'general.learn_more' | t
	endif
-%}

{%- if menu.links.size > 0 -%}
<header-bottom class="block-header-bottom__wrapper">
	<nav class="block-header-bottom__nav" aria-label="{{ section.settings.menu | replace: '-', ' ' | capitalize }}">
		<div class="block-header-bottom__menu-wrapper is-align-wide">
			<ul class="block-header-bottom__menu">
			{%- for link in menu.links -%}
				<li class="block-header-bottom__item{% if link.links.size > 0 %} has-dropdown{% endif %}">
					<a href="{{ link.url }}" aria-label="{{ link.title }}" {% if link.current %}aria-current="page"{% endif %}>
						<span>{{ link.title }}</span>
					</a>

					{%- if link.links.size > 0 -%}
						{%- liquid
							assign detected_collection = false
							assign detected_assist = false
							if link.url contains '/collections/'
								assign url_parts = link.url | split: '/'
								assign handle = url_parts.last
								assign detected_collection = collections[handle]
							endif
							if detected_collection
								assign detected_assist = detected_collection.metafields.custom['collection-assist-reference']
							endif
						-%}

						<div class="block-header-bottom__dropdown">
							<div class="block-header-bottom__dropdown-inner is-align-wide{% if detected_assist %} has-assist{% endif %}">
								<section class="block-header-bottom__links">
									<ul>
										{%- for child in link.links -%}
											{%- liquid
												assign link_collection = false
												if child.url contains '/collections/'
													assign url_parts = child.url | split: '/'
													assign handle = url_parts.last
													assign link_collection = collections[handle]
												endif
											-%}

											<li class="{% if child.links.size > 0 %}has-dropdown{% endif %}">
												<a href="{{ child.url }}" aria-label="{{ child.title }}" class="block-header-bottom__link">
													{%- if link_collection.image -%}
														<div class="block-header-bottom__link-image">
															{%- render 'html-theme-media',
															media: link_collection.image,
															alt: link_collection.image.alt | default: link_collection.title,
															width: 96,
															sizes: '72px',
															image_ratio: 'square',
															image_loading: 'lazy'
															-%}
														</div>
													{%- endif -%}
													<span>{{ child.title }}</span>
													{%- if child.links.size > 0 -%}
														<i class="block-header-bottom__caret">
															{% render 'html-theme-icons', icon: 'caret', size: 16 %}
														</i>
													{%- endif -%}
												</a>

												{%- if child.links.size > 0 -%}
													<div class="block-header-bottom__dropdown block-header-bottom__dropdown--nested">
														<div class="block-header-bottom__dropdown-inner is-align-wide{% if detected_assist %} has-assist{% endif %}">
															<section class="block-header-bottom__links">
																<ul>
																	<li class="block-header-bottom__navigate block-header-bottom__navigate--top">
																		<a href="{{ link.url }}" aria-label="{{ link.title }}" class="block-header-bottom__link block-header-bottom__link--back">
																			<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
																			<span>{{ link.title }}</span>
																		</a>
																		<a href="{{ child.url }}" aria-label="{{ child.title }}" class="block-header-bottom__link block-header-bottom__link--all">
																			<span>{{ child.title }}</span>
																			<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
																		</a>
																	</li>

																	{%- for subchild in child.links -%}
																		{%- liquid
																			assign sublink_collection = false
																			if subchild.url contains '/collections/'
																				assign url_parts = subchild.url | split: '/'
																				assign handle = url_parts.last
																				assign sublink_collection = collections[handle]
																			endif
																		-%}

																		<li>
																			<a href="{{ subchild.url }}" aria-label="{{ subchild.title }}" class="block-header-bottom__link">
																				{%- if sublink_collection.image -%}
																					<div class="block-header-bottom__link-image">
																						{%- render 'html-theme-media',
																						media: sublink_collection.image,
																						alt: sublink_collection.image.alt | default: sublink_collection.title,
																						width: 96,
																						sizes: '72px',
																						image_ratio: 'square',
																						image_loading: 'lazy'
																						-%}
																					</div>
																				{%- endif -%}
																				<span>{{ subchild.title }}</span>
																			</a>
																		</li>
																	{%- endfor -%}

																	<li class="block-header-bottom__navigate block-header-bottom__navigate--bottom">
																		<a href="{{ link.url }}" aria-label="{{ link.title }}" class="block-header-bottom__link block-header-bottom__link--back">
																			<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
																			<span>{{ link.title }}</span>
																		</a>
																		<a href="{{ child.url }}" aria-label="{{ child.title }}" class="block-header-bottom__link block-header-bottom__link--all">
																			<span>{{ child.title }}</span>
																			<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
																		</a>
																	</li>
																</ul>
															</section>

															{%- if detected_assist -%}
																{%- assign assist = detected_assist.value -%}
																<section class="block-header-bottom__assist">
																	<article class="block-header-bottom__assist-item">
																		{%- if assist.page -%}
																			<a href="{{ assist.page.value.url }}" aria-label="{{ assist.title }}" class="block-header-bottom__assist-overlay"></a>
																		{%- endif -%}
																		{%- if assist.image -%}
																			<div class="block-header-bottom__assist-image">
																				{%- render 'html-theme-media',
																				media: assist.image,
																				alt: assist.title,
																				width: 520,
																				sizes: '260px',
																				image_ratio: 'portrait',
																				image_loading: 'lazy'
																				-%}
																				</div>
																				{%- endif -%}
																				<section class="block-header-bottom__assist-content">
																				<h3>{{ assist.title }}</h3>
																				{%- if assist.page.value -%}
																				<span class="block-header-bottom__assist-link">
																				<span>{{ assist_link_text }}</span>
																				<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
																				</span>
																				{%- endif -%}
																				</section>
																				</article>
																				</section>
																				{%- endif -%}
																				</div>
																				</div>
																				{%- endif -%}
																				</li>
																				{%- endfor -%}

										<li class="block-header-bottom__navigate block-header-bottom__navigate--bottom">
											<a href="{{ link.url }}" class="block-header-bottom__link block-header-bottom__link--all">
												<span>{{ link.title }}</span>
												<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
											</a>
										</li>
									</ul>
								</section>

								{%- if detected_assist -%}
									{%- assign assist = detected_assist.value -%}
									<section class="block-header-bottom__assist">
										<article class="block-header-bottom__assist-item">
											{%- if assist.page -%}
												<a href="{{ assist.page.value.url }}" class="block-header-bottom__assist-overlay"></a>
											{%- endif -%}
											{%- if assist.image -%}
												<div class="block-header-bottom__assist-image">
													{%- render 'html-theme-media',
													media: assist.image,
													alt: assist.title,
													width: 520,
													sizes: '260px',
													image_ratio: 'portrait',
													image_loading: 'lazy'
													-%}
												</div>
											{%- endif -%}
											<section class="block-header-bottom__assist-content">
												<h3>{{ assist.title }}</h3>
												{%- if assist.page.value -%}
													<span class="block-header-bottom__assist-link">
														<span>{{ assist_link_text }}</span>
														<i>{% render 'html-theme-icons', icon: 'arrow', size: 16 %}</i>
													</span>
												{%- endif -%}
											</section>
										</article>
									</section>
								{%- endif -%}
							</div>
						</div>
					{%- endif -%}
				</li>
			{%- endfor -%}
			</ul>
		</div>
	</nav>
</header-bottom>
{%- endif -%}

{% style %}
	#shopify-section-{{ section.id }}.block-header-bottom {
		background-color: {{ section.settings.background_color | default: '#ffffff' }};
		color: {{ section.settings.text_color | default: '#2e130d' }};
	}
{% endstyle %}

{% javascript %}
	class HeaderBottom extends HTMLElement {
		constructor() {
			super();
		}

		connectedCallback() {
			this.nav = this.querySelector('.block-header-bottom__nav');
			if (this.nav) {
				this.initDesktopNav();
			}
		}

		initDesktopNav() {
			const allItems = [...this.nav.querySelectorAll('li')];

			const getAncestors = (li, boundary) => {
				const ancestors = [];
				let parent = li.parentElement;
				while (parent && parent !== boundary) {
					if (parent.tagName.toLowerCase() === 'li') {
						ancestors.push(parent);
					}
					parent = parent.parentElement;
				}
				return ancestors;
			};

			this.nav.addEventListener('mouseleave', () => {
				allItems.forEach(item => item.classList.remove('is-selected'));
			});

			this.nav.addEventListener('click', (event) => {
				const link = event.target.closest('.has-dropdown > .block-header-bottom__link');
				if (link) {
					const listItem = link.closest('li');
					if (listItem.closest('.block-header-bottom__dropdown')) {
						event.preventDefault();
						const ancestors = getAncestors(listItem, this.nav);
						allItems.forEach(item => {
							if (ancestors.includes(item)) {
								item.classList.add('is-selected');
							} else if (item === listItem) {
								item.classList.toggle('is-selected');
							} else {
								item.classList.remove('is-selected');
							}
						});
					}
				}

				if (event.target.closest('.block-header-bottom__link--back')) {
					event.preventDefault();
					const listItem = event.target.closest('li');
					const ancestors = getAncestors(listItem, this.nav);
					if (ancestors.length > 0) {
						ancestors[0].classList.remove('is-selected');
					}
				}
			});
		}

		disconnectedCallback() {}
	}

	customElements.define('header-bottom', HeaderBottom);
{% endjavascript %}

{% schema %}
{
	"name": "Header bottom",
	"tag": "section",
	"class": "block-header-bottom",
	"limit": 1,
	"enabled_on": {
		"groups": ["header"]
	},
	"settings": [
		{
			"type": "header",
			"content": "Content"
		},
		{
			"type": "link_list",
			"id": "menu",
			"label": "Menu"
		},
		{
			"type": "text",
			"id": "assist_link_text",
			"label": "Assist link text",
			"info": "Leave empty to use locale default"
		},
		{
			"type": "header",
			"content": "Colors"
		},
		{
			"type": "color",
			"id": "background_color",
			"label": "Background"
		},
		{
			"type": "color",
			"id": "text_color",
			"label": "Text"
		},
		{
			"type": "header",
			"content": "Howto"
		},
		{
			"type": "paragraph",
			"content": "Select a menu with nested links. Dropdowns show collection images when links point to collections. Assist content is pulled from collection metafields."
		}
	],
	"presets": [
		{
			"name": "Navigation",
			"category": "Header"
		}
	]
}
{% endschema %}
