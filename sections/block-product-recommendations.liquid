{%- comment -%} sections/block-product-recommendations.liquid {%- endcomment -%}
<section id="product-recommendations-{{ section.id }}" class="product-recommendations-content alignwide">
  <h2>{{ section.settings.heading | default: 'Gerelateerde producten' }}</h2>
  <div class="product-recommendations" data-list></div>

  {%- comment -%} SERVER RENDER PAD (gebruikt door section_id fetch) {%- endcomment -%}
  {%- if recommendations and recommendations.performed and recommendations.products_count > 0 -%}
	<ul class="is-grid is-product-grid js-recos" role="list">
	  {%- for p in recommendations.products limit: section.settings.limit -%}
	  	<li class="class="grid__item">
		{%- render 'html-product-card', 
			product: p, 
			show_secondary_image: true,
			show_vendor: false, 
			show_price:true,
			show_stock: true,
			show_delivery: true,
			show_rating: true,
			show_badges: true, 
			quick_add: false, 
			context: 'recommendations' 
		-%}
		  </li>
	  {%- endfor -%}
	</ul>
  {%- endif -%}
</section>

<script>
(function(){
  // 1) Scope + init guard
  var root = document.getElementById('product-recommendations-{{ section.id }}');
  if (!root || root.dataset.recosInit === '1') return;
  root.dataset.recosInit = '1';

  var host = root.querySelector('[data-list]');
  if (!host) return;

  // Als SSR al gevuld heeft, gebruik die en klaar
  var ssr = root.querySelector('.js-recos');
  if (ssr) { host.innerHTML = ''; host.appendChild(ssr); safeLazyUpdate(host); return; }

  var productId = {{ product.id }};
  var limit     = {{ section.settings.limit | default: 4 }};
  var inflight  = null;
  var loaded    = false;

  function getPreviewThemeId(){
	try { return new URL(location.href).searchParams.get('preview_theme_id') || ''; }
	catch(_){ return ''; }
  }

  function buildURL(){
	var url = new URL('/recommendations/products', location.origin);
	url.searchParams.set('product_id', productId);
	url.searchParams.set('limit', limit);
	url.searchParams.set('section_id', '{{ section.id }}');
	// dev help: preview_theme_id + cache buster
	var pt = getPreviewThemeId(); if (pt) url.searchParams.set('preview_theme_id', pt);
	url.searchParams.set('_cb', Date.now().toString());
	return url.toString();
  }

  function safeLazyUpdate(ctx){
	var nodes = (ctx && ctx.querySelectorAll) ? ctx.querySelectorAll('.lazy') : document.querySelectorAll('.lazy');
	if (window.altLazy && typeof window.altLazy.update === 'function') {
	  try { window.altLazy.update(nodes); } catch(_){}
	} else if (window.LazyLoad && typeof window.LazyLoad.load === 'function') {
	  nodes.forEach(function(el){ try { window.LazyLoad.load(el, window.lazyLoadOptions || { elements_selector: '.lazy' }); } catch(_){}} );
	} else {
	  window.addEventListener('LazyLoad::Initialized', function(e){
		try { e.detail.instance.update(nodes); } catch(_){}
	  }, { once:true });
	}
  }

  // 4) fetch met 429 backoff (max 3)
  function fetchWithRetry(url, opts, tries){
	return fetch(url, opts).then(function(r){
	  if (r.status === 429 && tries > 0) {
		// exponentiÃ«le backoff met jitter
		var delay = Math.min(1500, (2 ** (3 - tries)) * 250) + Math.random()*150;
		return new Promise(function(res){ setTimeout(res, delay); }).then(function(){
		  return fetchWithRetry(url, opts, tries - 1);
		});
	  }
	  if (!r.ok) return Promise.reject(r);
	  return r.text();
	});
  }

  function load(){
	if (loaded) return;
	if (inflight && inflight.abort) inflight.abort();
	inflight = new AbortController();

	var url = buildURL();
	fetchWithRetry(url, {
	  headers: {
		'X-Requested-With': 'XMLHttpRequest',
		'Cache-Control': 'no-cache, no-store'
	  },
	  cache: 'no-store',
	  signal: inflight.signal,
	  credentials: 'same-origin'
	}, 3)
	.then(function(html){
	  var doc = new DOMParser().parseFromString(html, 'text/html');
	  var sec = doc.getElementById('shopify-section-{{ section.id }}');
	  if (!sec) return;
	  var ul = sec.querySelector('.js-recos');
	  if (!ul) return;
	  host.innerHTML = '';
	  host.appendChild(ul);
	  loaded = true;
	  safeLazyUpdate(host);
	})
	.catch(function(_err){
	  // dev: stil falen; in live kan je hier evt. loggen
	});
  }

  // 2) Lazy: alleen ophalen als in beeld
  if ('IntersectionObserver' in window) {
	var io = new IntersectionObserver(function(entries){
	  entries.forEach(function(entry){
		if (entry.isIntersecting) { io.disconnect(); load(); }
	  });
	}, { rootMargin: '200px 0px' });
	io.observe(root);
  } else {
	// fallback: haal direct op
	load();
  }

  // 3) HMR/hot reload safety: als de section vervangen wordt, stop lopende request
  document.addEventListener('shopify:section:unload', function(e){
	if (e && e.detail && e.detail.sectionId === '{{ section.id }}') {
	  try { inflight && inflight.abort(); } catch(_){}
	}
  });
})();
</script>

{% style %}
.block-product-recommendations {
	background-color: var(--theme-color-grey);
	padding-top: 0em; padding-bottom: 4em;
}
.product-recommendations-content {
	& h2 {
		margin-top: 0; text-align: center; margin-bottom: 1em;
	}
}
{% endstyle %}

{% schema %}
{
  "name": "Product recommendations",
  "tag": "section",
  "class": "block-product-recommendations",
  "disabled_on": {
	"groups": ["header", "footer"]
  },
  "settings": [],
  "presets": [
	{
	  "name": "Product recommendations",
	  "category": "Homework",
	}
  ]
}
{% endschema %}