{%- comment -%}
============================================================================
BLOCK-MARKETING-ARTICLES-RELATED
============================================================================
Related articles section based on matching tags.
Only for use on article pages.

FEATURES:
- Shows articles with matching tags
- Excludes current article
- Configurable number of articles
- Falls back to recent articles from same blog if no tag matches

DEPENDENCIES:
- html-article-card snippet
============================================================================
{%- endcomment -%}

{%- liquid
	assign heading_text = section.settings.heading
	if heading_text == blank
		assign heading_text = 'product.related_blogs_heading' | t
	endif
	
	assign max_articles = section.settings.max_articles | default: 4
	assign current_handle = article.handle
	assign current_tags = article.tags
	
	comment
		Collect related articles based on matching tags
		Build as comma-separated handles, then fetch articles
	endcomment
	assign related_handles = ''
	assign related_count = 0
	
	if current_tags.size > 0
		for blog_article in blog.articles
			if blog_article.handle != current_handle and related_count < max_articles
				assign has_matching_tag = false
				for tag in current_tags
					if blog_article.tags contains tag
						assign has_matching_tag = true
						break
					endif
				endfor
				
				if has_matching_tag
					if related_handles == ''
						assign related_handles = blog_article.handle
					else
						assign related_handles = related_handles | append: ',' | append: blog_article.handle
					endif
					assign related_count = related_count | plus: 1
				endif
			endif
		endfor
	endif
	
	comment
		Fallback: if not enough related articles, fill with recent from same blog
	endcomment
	if related_count < max_articles and section.settings.show_fallback
		for blog_article in blog.articles
			if blog_article.handle != current_handle and related_count < max_articles
				unless related_handles contains blog_article.handle
					if related_handles == ''
						assign related_handles = blog_article.handle
					else
						assign related_handles = related_handles | append: ',' | append: blog_article.handle
					endif
					assign related_count = related_count | plus: 1
				endunless
			endif
		endfor
	endif
	
	assign related_handles_array = related_handles | split: ','
-%}

{%- if related_count > 0 -%}
	<div class="block-marketing-articles-related__content {{ section.settings.width }}{% if section.settings.custom_class != blank %} {{ section.settings.custom_class }}{% endif %}">
		<header class="block-marketing-articles-related__header">
			<h2 class="block-marketing-articles-related__title">{{ heading_text }}</h2>
			{%- if section.settings.subheading != blank -%}
				<p class="block-marketing-articles-related__subheading">{{ section.settings.subheading }}</p>
			{%- endif -%}
		</header>

		<ul class="block-marketing-articles-related__grid" style="--grid-columns: {{ section.settings.columns_desktop | default: 4 }}; --grid-columns-tablet: {{ section.settings.columns_tablet | default: 3 }}; --grid-columns-mobile: {{ section.settings.columns_mobile | default: 1 }};">
			{%- for handle in related_handles_array -%}
				{%- for blog_article in blog.articles -%}
					{%- if blog_article.handle == handle -%}
						<li class="block-marketing-articles-related__item">
							{%- render 'html-article-card',
								article: blog_article,
								blog_title: blog.title,
								layout: section.settings.card_layout,
								show_image: section.settings.show_image,
								show_blog: section.settings.show_blog_title,
								show_date: section.settings.show_date,
								show_excerpt: section.settings.show_excerpt,
								show_cta: section.settings.show_cta,
								image_ratio: section.settings.image_ratio,
								lazy_load: true,
								card_background: section.settings.card_background_color,
								card_text_color: section.settings.card_text_color
							-%}
						</li>
						{%- break -%}
					{%- endif -%}
				{%- endfor -%}
			{%- endfor -%}
		</ul>
	</div>
{%- endif -%}

{% style %}
	#shopify-section-{{ section.id }}.block-marketing-articles-related {
		background-color: {{ section.settings.background_color | default: '#f8f8f8' }};
		color: {{ section.settings.text_color | default: '#111111' }};
		padding-block: 3em;
	}

	#shopify-section-{{ section.id }} .block-marketing-articles-related__header {
		margin-bottom: 2em;
		text-align: {{ section.settings.text_align | default: 'center' }};
	}

	.block-marketing-articles-related__title {
		font-family: var(--theme-font-family-serif);
		font-size: clamp(1.6em, 4vw, 2em);
		font-weight: 400;
		margin: 0;
	}

	.block-marketing-articles-related__subheading {
		margin: 0.5em 0 0;
		opacity: 0.8;
	}

	.block-marketing-articles-related__grid {
		display: grid;
		grid-template-columns: repeat(var(--grid-columns, 4), 1fr);
		gap: 0.5em;
		list-style: none;
		margin: 0;
		padding: 0;
	}

	.block-marketing-articles-related__item {
		display: flex;
		min-width: 0;
	}

	@media (max-width: 64em) {
		.block-marketing-articles-related__grid {
			grid-template-columns: repeat(var(--grid-columns-tablet, 3), 1fr);
		}
	}

	@media (max-width: 47.5em) {
		.block-marketing-articles-related__grid {
			grid-template-columns: repeat(var(--grid-columns-mobile, 1), 1fr);
		}
	}
{% endstyle %}

{% schema %}
{
	"name": "Related articles",
	"tag": "section",
	"class": "block-marketing-articles-related",
	"enabled_on": {
		"templates": ["article"]
	},
	"settings": [
		{
			"type": "header",
			"content": "Content"
		},
		{
			"type": "text",
			"id": "heading",
			"label": "Heading",
			"info": "Leave empty to use locale default"
		},
		{
			"type": "text",
			"id": "subheading",
			"label": "Subheading"
		},
		{
			"type": "range",
			"id": "max_articles",
			"label": "Maximum articles",
			"min": 2,
			"max": 8,
			"step": 1,
			"default": 4
		},
		{
			"type": "checkbox",
			"id": "show_fallback",
			"label": "Show recent articles if no tag matches",
			"default": true
		},
		{
			"type": "header",
			"content": "Article card"
		},
		{
			"type": "select",
			"id": "card_layout",
			"label": "Card layout",
			"options": [
				{ "value": "vertical", "label": "Vertical" },
				{ "value": "horizontal", "label": "Horizontal" }
			],
			"default": "vertical"
		},
		{
			"type": "checkbox",
			"id": "show_image",
			"label": "Show image",
			"default": true
		},
		{
			"type": "select",
			"id": "image_ratio",
			"label": "Image ratio",
			"options": [
				{ "value": "adapt", "label": "Adapt" },
				{ "value": "square", "label": "Square (1:1)" },
				{ "value": "portrait", "label": "Portrait (2:3)" },
				{ "value": "landscape", "label": "Landscape (3:2)" }
			],
			"default": "landscape"
		},
		{
			"type": "checkbox",
			"id": "show_blog_title",
			"label": "Show blog title",
			"default": false
		},
		{
			"type": "checkbox",
			"id": "show_date",
			"label": "Show article date",
			"default": true
		},
		{
			"type": "checkbox",
			"id": "show_excerpt",
			"label": "Show article excerpt",
			"default": false
		},
		{
			"type": "checkbox",
			"id": "show_cta",
			"label": "Show read more link",
			"default": false
		},
		{
			"type": "header",
			"content": "Layout"
		},
		{
			"type": "select",
			"id": "width",
			"label": "Width",
			"options": [
				{ "value": "alignsmall", "label": "Narrow" },
				{ "value": "align", "label": "Regular" },
				{ "value": "alignwide", "label": "Wide" },
				{ "value": "alignfull", "label": "Full" }
			],
			"default": "alignwide"
		},
		{
			"type": "select",
			"id": "text_align",
			"label": "Header alignment",
			"options": [
				{ "value": "left", "label": "Left" },
				{ "value": "center", "label": "Center" }
			],
			"default": "center"
		},
		{
			"type": "range",
			"id": "columns_desktop",
			"label": "Columns (desktop)",
			"min": 1,
			"max": 4,
			"step": 1,
			"default": 4
		},
		{
			"type": "select",
			"id": "columns_tablet",
			"label": "Columns (tablet)",
			"options": [
				{ "value": "1", "label": "1" },
				{ "value": "2", "label": "2" },
				{ "value": "3", "label": "3" }
			],
			"default": "3"
		},
		{
			"type": "select",
			"id": "columns_mobile",
			"label": "Columns (mobile)",
			"options": [
				{ "value": "1", "label": "1" },
				{ "value": "2", "label": "2" }
			],
			"default": "1"
		},
		{
			"type": "header",
			"content": "Colors"
		},
		{
			"type": "color",
			"id": "background_color",
			"label": "Section background",
			"default": "#f8f8f8"
		},
		{
			"type": "color",
			"id": "text_color",
			"label": "Section text",
			"default": "#111111"
		},
		{
			"type": "color",
			"id": "card_background_color",
			"label": "Card background",
			"default": "#ffffff"
		},
		{
			"type": "color",
			"id": "card_text_color",
			"label": "Card text",
			"default": "#111111"
		},
		{
			"type": "header",
			"content": "Advanced"
		},
		{
			"type": "text",
			"id": "custom_class",
			"label": "Custom class",
			"info": "Add custom CSS class for styling"
		}
	],
	"presets": [
		{
			"name": "Related articles",
			"category": "Marketing"
		}
	]
}
{% endschema %}
