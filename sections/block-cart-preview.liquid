{%- comment -%}
  ============================================================================
  BLOCK-CART-PREVIEW
  ============================================================================

  Purpose:
  Cart preview drawer that slides in from the right.
  Shows cart items, subtotal, and checkout options.
  
  Usage:
  Add to footer-group.json or header-group.json.
  Triggered by html-button-cart with open_drawer: true.

  Dependencies:
  - theme-drawer.js
  - theme-cart.js
  - html-cart-items snippet
  - html-cart-subtotal snippet
  - html-cart-payments snippet
  - html-theme-icons snippet

  ============================================================================
{%- endcomment -%}

<script src="{{ 'theme-cart.js' | asset_url }}" defer="defer"></script>

<div 
  class="block-cart-preview"
  id="cart-preview"
  data-drawer="cart-drawer"
  data-drawer-position="right"
  data-cart-preview-section="{{ section.id }}"
  data-cart-context="preview"
  data-disable-on-cart="{{ section.settings.disable_on_cart }}"
  role="dialog"
  aria-modal="true"
  aria-label="{{ 'cart.title' | t }}"
  hidden
>
  <div class="block-cart-preview__overlay" data-drawer-overlay></div>
  
  <div class="block-cart-preview__content theme-drawer__content">
    {%- comment -%} Header {%- endcomment -%}
    <div class="block-cart-preview__header theme-drawer__header">
      <h2 class="block-cart-preview__title theme-drawer__title">
        {{ 'cart.title' | t }}
        <span class="block-cart-preview__count" data-cart-count>({{ cart.item_count }})</span>
      </h2>
      <button 
        class="block-cart-preview__close theme-drawer__close" 
        type="button" 
        aria-label="{{ 'accessibility.close' | t }}"
        data-drawer-close
      >
        {%- render 'html-theme-icons', icon: 'close', size: 24 -%}
      </button>
    </div>

    {%- if cart.item_count > 0 -%}
      {%- comment -%} Content - Cart Items {%- endcomment -%}
      <div class="block-cart-preview__body theme-drawer__body">
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- when 'cart_items' -%}
              <div 
                class="block-cart-preview__block" 
                {{ block.shopify_attributes }}
                data-cart-items-section="{{ section.id }}"
              >
                {% render 'html-cart-items', 
                  cart: cart,
                  show_vendor: block.settings.show_vendor,
                  show_recommended: block.settings.show_recommended,
                  max_recommended: block.settings.max_recommended,
                  hide_out_of_stock: block.settings.hide_out_of_stock,
                  compact: true
                %}
              </div>

            {%- when '@app' -%}
              <div class="block-cart-preview__block" {{ block.shopify_attributes }}>
                {% render block %}
              </div>
          {%- endcase -%}
        {%- endfor -%}
      </div>

      {%- comment -%} Footer - Subtotal, Payments, View Cart {%- endcomment -%}
      <div class="block-cart-preview__footer theme-drawer__footer">
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- when 'cart_subtotal' -%}
              <div 
                class="block-cart-preview__block" 
                {{ block.shopify_attributes }}
                data-cart-subtotal-section="{{ section.id }}"
              >
                {% render 'html-cart-subtotal', 
                  cart: cart,
                  show_cart_note: block.settings.show_cart_note,
                  show_discount_code: block.settings.show_discount_code,
                  context: 'drawer'
                %}
              </div>

            {%- when 'cart_payments' -%}
              <div 
                class="block-cart-preview__block" 
                {{ block.shopify_attributes }}
                data-cart-payments-section="{{ section.id }}"
              >
                {% render 'html-cart-payments', 
                  cart: cart,
                  show_terms: block.settings.show_terms,
                  terms_text: block.settings.terms_text,
                  show_additional_buttons: block.settings.show_additional_buttons,
                  button_text: block.settings.button_text,
                  context: 'drawer'
                %}
              </div>
          {%- endcase -%}
        {%- endfor -%}

        {%- if section.settings.show_view_cart -%}
          <a href="{{ routes.cart_url }}" class="block-cart-preview__view-cart">
            {{ 'cart.view_cart' | t }}
          </a>
        {%- endif -%}
      </div>
    {%- else -%}
      {%- comment -%} Empty State {%- endcomment -%}
      <div class="block-cart-preview__empty">
        <p class="block-cart-preview__empty-text">{{ 'cart.empty' | t }}</p>
        <button 
          class="button" 
          type="button"
          data-drawer-close
        >
          {{ 'general.continue_shopping' | t }}
        </button>
      </div>
    {%- endif -%}
  </div>
</div>

<style>
  .block-cart-preview__content {
    width: 100%;
    max-width: 420px;
  }

  .block-cart-preview__count {
    font-weight: 400;
    opacity: 0.7;
  }

  .block-cart-preview__body {
    flex: 1 1 auto;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .block-cart-preview__footer {
    flex-direction: column;
  }

  .block-cart-preview__block {
    margin-bottom: 0;
  }

  .block-cart-preview__block:last-child {
    margin-bottom: 0;
  }

  .block-cart-preview__view-cart {
    display: block;
    margin-top: 0;
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: 1px solid currentColor;
    color: inherit;
    text-align: center;
    text-decoration: none;
    font-weight: 600;
    transition: background-color 200ms ease, color 200ms ease;
  }

  .block-cart-preview__view-cart:hover {
    background: var(--theme-color-foreground, #111);
    color: var(--theme-color-background, #fff);
  }

  .block-cart-preview__empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1.5rem;
    text-align: center;
  }

  .block-cart-preview__empty-text {
    margin: 0 0 1.5rem;
    font-size: 1.125rem;
  }

  @media (max-width: 40em) {
    .block-cart-preview__content {
      max-width: 100%;
    }
  }
</style>

<script>
  (function() {
    const preview = document.querySelector('[data-cart-preview-section]');
    if (!preview) return;

    const disableOnCart = preview.dataset.disableOnCart === 'true';
    const isCartPage = window.location.pathname === '/cart' || window.location.pathname.includes('/cart');

    // Prevent opening on cart page if disabled
    if (disableOnCart && isCartPage) {
      document.addEventListener('drawer:open', function(e) {
        if (e.detail.id === 'cart-drawer') {
          e.preventDefault();
          window.themeDrawer.close('cart-drawer');
        }
      });
    }

    // Update count on cart changes
    if (window.CartEvents) {
      window.CartEvents.subscribe('cart:update', function(data) {
        const countEl = preview.querySelector('[data-cart-count]');
        if (countEl) {
          countEl.textContent = '(' + data.cart.item_count + ')';
        }
      });
    }

    // Legacy API compatibility
    window.CartPreview = {
      open: function() {
        if (window.themeDrawer) window.themeDrawer.open('cart-drawer');
      },
      close: function() {
        if (window.themeDrawer) window.themeDrawer.close('cart-drawer');
      },
      toggle: function() {
        if (window.themeDrawer) {
          if (window.themeDrawer.isOpen('cart-drawer')) {
            window.themeDrawer.close('cart-drawer');
          } else {
            window.themeDrawer.open('cart-drawer');
          }
        }
      }
    };
  })();
</script>

{% schema %}
{
  "name": "Cart preview",
  "tag": "section",
  "class": "section-cart-preview",
  "enabled_on": {
    "groups": ["footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "checkbox",
      "id": "show_view_cart",
      "label": "Show view cart link",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "disable_on_cart",
      "label": "Disable on cart page",
      "default": true
    },
    {
      "type": "header",
      "content": "Howto"
    },
    {
      "type": "paragraph",
      "content": "Slide-out drawer triggered by cart icon. Add to header or footer group."
    }
  ],
  "blocks": [
    {
      "type": "cart_items",
      "name": "Cart items",
      "limit": 1,
      "settings": [
        {
          "type": "header",
          "content": "Product"
        },
        {
          "type": "checkbox",
          "id": "show_vendor",
          "label": "Show vendor",
          "default": false
        },
        {
          "type": "header",
          "content": "Recommended products"
        },
        {
          "type": "checkbox",
          "id": "show_recommended",
          "label": "Show recommended products",
          "info": "Display products from metafield custom.recommended-products under each cart item.",
          "default": true
        },
        {
          "type": "range",
          "id": "max_recommended",
          "label": "Max recommended products",
          "min": 1,
          "max": 6,
          "step": 1,
          "default": 4
        },
        {
          "type": "checkbox",
          "id": "hide_out_of_stock",
          "label": "Hide out of stock products",
          "default": false
        }
      ]
    },
    {
      "type": "cart_subtotal",
      "name": "Cart subtotal",
      "limit": 1,
      "settings": [
        {
          "type": "header",
          "content": "Content"
        },
        {
          "type": "checkbox",
          "id": "show_discount_code",
          "label": "Show discount code field",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_cart_note",
          "label": "Show cart note field",
          "default": false
        }
      ]
    },
    {
      "type": "cart_payments",
      "name": "Cart payments",
      "limit": 1,
      "settings": [
        {
          "type": "header",
          "content": "Content"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button text",
          "info": "Leave empty to use locale default"
        },
        {
          "type": "checkbox",
          "id": "show_additional_buttons",
          "label": "Show dynamic checkout buttons",
          "info": "Apple Pay, Google Pay, etc.",
          "default": true
        },
        {
          "type": "header",
          "content": "Terms"
        },
        {
          "type": "checkbox",
          "id": "show_terms",
          "label": "Show terms",
          "default": false
        },
        {
          "type": "textarea",
          "id": "terms_text",
          "label": "Terms text",
          "info": "Leave empty to use locale default. Supports HTML."
        }
      ]
    },
    {
      "type": "@app"
    }
  ],
  "presets": [
    {
      "name": "Preview",
      "category": "Cart",
      "blocks": [
        { "type": "cart_items" },
        { "type": "cart_subtotal" },
        { "type": "cart_payments" }
      ]
    }
  ]
}
{% endschema %}
