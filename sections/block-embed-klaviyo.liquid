{%- comment -%}
============================================================================
BLOCK-EMBED-KLAVIYO
============================================================================
Klaviyo popup triggers via anchor links.

FEATURES:
- Define triggers that open Klaviyo popups on click
- Links with href="#anchor-id" trigger the corresponding popup
- Multiple triggers per page supported
- Zero UI - only outputs JavaScript when triggers exist

USAGE:
1. Add this section to footer-group.json
2. Create trigger blocks with anchor ID and Klaviyo form ID
3. Add links anywhere: <a href="#open-newsletter">Subscribe</a>

DEPENDENCIES:
- Klaviyo script must be loaded on the page
============================================================================
{%- endcomment -%}

{%- if section.blocks.size > 0 -%}
<script>
(function() {
	const triggers = {
		{%- for block in section.blocks -%}
			{%- if block.type == 'trigger' and block.settings.anchor_id != blank and block.settings.trigger_id != blank -%}
				{%- assign normalized_anchor = block.settings.anchor_id | remove: '#' | strip | downcase | replace: ' ', '-' | escape -%}
				'{{ normalized_anchor }}': ['{{ block.settings.trigger_type | default: 'openForm' }}', '{{ block.settings.trigger_id | strip | escape }}']{% unless forloop.last %},{% endunless %}
			{%- endif -%}
		{%- endfor -%}
	};

	if (Object.keys(triggers).length === 0) return;

	document.addEventListener('click', function(e) {
		const link = e.target.closest('a[href^="#"]');
		if (!link) return;

		const anchor = link.getAttribute('href').substring(1).toLowerCase().replace(/\s+/g, '-');
		if (!triggers[anchor]) return;

		e.preventDefault();
		window._klOnsite = window._klOnsite || [];
		window._klOnsite.push(triggers[anchor]);
	});
})();
</script>
{%- endif -%}

{% schema %}
{
	"name": "Klaviyo triggers",
	"tag": "section",
	"class": "block-embed-klaviyo",
	"limit": 1,
	"enabled_on": {
		"groups": ["footer"]
	},
	"settings": [
		{
			"type": "paragraph",
			"content": "Add triggers to open Klaviyo popups via anchor links. Use links like <a href=\"#anchor-id\">Subscribe</a> anywhere on your site."
		}
	],
	"blocks": [
		{
			"type": "trigger",
			"name": "Trigger",
			"settings": [
				{
					"type": "text",
					"id": "anchor_id",
					"label": "Anchor link ID",
					"info": "Links with href=\"#anchor-id\" will trigger this popup. Use lowercase and hyphens only.",
					"placeholder": "open-newsletter"
				},
				{
					"type": "select",
					"id": "trigger_type",
					"label": "Trigger type",
					"options": [
						{ "value": "openForm", "label": "Open form" }
					],
					"default": "openForm"
				},
				{
					"type": "text",
					"id": "trigger_id",
					"label": "Klaviyo form ID",
					"info": "Find this in Klaviyo under Forms > Form ID",
					"placeholder": "VB3PF9"
				}
			]
		}
	],
	"presets": [
		{
			"name": "Klaviyo triggers",
			"category": "Embed"
		}
	]
}
{% endschema %}
